import{r as a,j as e,z as k,a as Es}from"./react-vendor-D3yaKSZ_.js";import{a as w}from"./index-BZXaxw8W.js";import"./chart-vendor-BsnJAHr2.js";import"./bootstrap-vendor-CM53U_Of.js";import"./vendor-axios-ngrFHoWO.js";import"./pdf-vendor-BZobkf7J.js";import"./vendor-utils-DLELI0UM.js";import"./excel-vendor-6kUf8nhb.js";function Vs({visit:o,onClose:C,onComplete:y}){var Fe,De,Te,Me,Ie;const[r,A]=a.useState(1),[Y,W]=a.useState([]),[h,I]=a.useState([]),[G,U]=a.useState(!1),[q,P]=a.useState(!1),[L,E]=a.useState([]),[se,_]=a.useState(""),[f,le]=a.useState(""),[i,F]=a.useState(""),[T,M]=a.useState(""),[H,$]=a.useState(null),[ue,B]=a.useState(!1),[te,j]=a.useState(null),[xe,J]=a.useState(!1),[ne,Ne]=a.useState("paid"),[de,Se]=a.useState(""),[ee,ke]=a.useState(""),[me,c]=a.useState(null);a.useEffect(()=>{g(),b()},[]);const g=async()=>{try{const n=await w.get("/api/inventory/items");W(n.data.data||[])}catch(n){console.error("Failed to load inventory items",n)}},b=async()=>{var n,v,p;try{const S=await w.get(`/api/visits/${o.id}/dentist-notes`),O=S.data;O.dentist_notes&&_(O.dentist_notes),O.findings&&le(O.findings),O.treatment_plan&&F(O.treatment_plan),O.teeth_treated&&M(O.teeth_treated),typeof((n=S.data)==null?void 0:n.service_price_at_date)=="number"&&c(Number(S.data.service_price_at_date)),(O.created_by||O.created_at)&&$({created_by:O.created_by,created_at:O.created_at,updated_by:O.updated_by,updated_at:O.updated_at})}catch(S){console.log("No dentist notes found or error fetching notes:",(p=(v=S==null?void 0:S.response)==null?void 0:v.data)==null?void 0:p.message)}},x=()=>{I([...h,{item_id:"",quantity:"",notes:""}])},N=(n,v,p)=>{const S=[...h];S[n][v]=p,I(S)},R=n=>{I(h.filter((v,p)=>p!==n))},V=(n,v)=>{const p=L.some(S=>S.item_id===n);E(p?L.filter(S=>S.item_id!==n):[...L,{item_id:n,quantity:1,unit_price:Number(v.patient_price)||0}])},he=(n,v)=>{E(L.map(p=>p.item_id===n?{...p,quantity:Math.max(1,Number(v)||1)}:p))},be=async()=>{const n=h.filter(p=>p.item_id&&p.quantity),v={stock_items:n,billable_items:L.map(p=>({item_id:p.item_id,quantity:Number(p.quantity)||1,unit_price:Number(p.unit_price)||0})),dentist_notes:se,findings:f,treatment_plan:i,teeth_treated:T,payment_status:ie?"paid":ne,onsite_payment_amount:ie?null:de?Number(de):null,payment_method_change:ie?null:ee||null};if(n.length===0&&!xe){j(v),B(!0);return}await re(v)},re=async n=>{var v,p;P(!0);try{await w.post(`/api/visits/${o.id}/complete-with-details`,n);try{const S=await w.post(`/api/receipts/visit/${o.id}/email`,{},{skip401Handler:!0});S.data.note?k.success(`Visit completed successfully!

${S.data.message}

${S.data.note}`):k.success(`Visit completed successfully!

Receipt sent to: ${S.data.email}`)}catch(S){console.error("Failed to send receipt email:",S),k.success(`Visit completed successfully!

Note: Receipt email could not be sent. Patient can download receipt from their appointments page.`)}y(),C()}catch(S){k.error(((p=(v=S==null?void 0:S.response)==null?void 0:v.data)==null?void 0:p.message)||"Failed to complete visit")}finally{j(null),J(!1),P(!1)}},pe=((Fe=o.payments)==null?void 0:Fe.reduce((n,v)=>n+(Number(v.amount_paid)||0),0))||0,Ae=Number((De=o.service)==null?void 0:De.price)||0,K=me??Ae,ae=!!((Te=o.service)!=null&&Te.per_teeth_service),ge=L.reduce((n,v)=>{const p=Number(v.unit_price)||0,S=Number(v.quantity)||1;return n+p*S},0),Z=K+ge,je=Z-pe,Ce=(Me=o.payments)==null?void 0:Me.find(n=>n.method==="maya"&&n.status==="paid"),ie=!!Ce;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"modal fade show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1050,overflowY:"auto",display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem"},tabIndex:"-1",role:"dialog",children:e.jsx("div",{className:"modal-dialog modal-lg",role:"document",style:{maxWidth:"800px",maxHeight:"calc(100vh - 2rem)",margin:"0 auto",width:"100%"},children:e.jsxs("div",{className:"modal-content d-flex flex-column",style:{maxHeight:"calc(100vh - 2rem)",overflow:"hidden"},children:[e.jsxs("div",{className:"modal-header bg-primary text-white py-2 flex-shrink-0",style:{position:"sticky",top:0,zIndex:1,borderBottom:"1px solid #dee2e6"},children:[e.jsxs("h5",{className:"modal-title fw-bold mb-0",children:[e.jsx("i",{className:"fas fa-check-circle me-2"}),"Complete Visit"]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:C,"aria-label":"Close",style:{fontSize:"1.2rem"}})]}),e.jsxs("div",{className:"modal-body p-3 flex-grow-1",style:{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:0},children:[e.jsx("div",{className:"d-flex justify-content-center mb-3",children:e.jsx("div",{className:"progress w-100",style:{height:"4px"},children:e.jsx("div",{className:"progress-bar bg-primary",role:"progressbar",style:{width:`${r/3*100}%`},"aria-valuenow":r,"aria-valuemin":"0","aria-valuemax":"3"})})}),e.jsx("div",{className:"d-flex justify-content-between mb-3",children:[1,2,3].map(n=>e.jsxs("div",{className:"d-flex flex-column align-items-center",children:[e.jsx("div",{className:`rounded-circle d-flex align-items-center justify-content-center mb-1 ${r>=n?"bg-primary text-white shadow-sm":"bg-light text-muted border"}`,style:{width:"36px",height:"36px",fontSize:"14px"},children:e.jsx("i",{className:`fas ${n===1?"fa-boxes":n===2?"fa-sticky-note":"fa-credit-card"}`})}),e.jsxs("small",{className:`text-center ${r>=n?"text-primary fw-bold":"text-muted"}`,style:{fontSize:"12px"},children:[n===1&&"Stock",n===2&&"Notes",n===3&&"Payment"]})]},n))}),r===1&&e.jsxs("div",{className:"card border-0 shadow-sm",children:[e.jsx("div",{className:"card-header bg-gradient bg-light py-2",children:e.jsxs("h6",{className:"card-title mb-0",children:[e.jsx("i",{className:"fas fa-boxes text-primary me-2"}),"Consume Stock Items"]})}),e.jsxs("div",{className:"card-body p-3",children:[h.length>0?e.jsx("div",{className:"row g-2",children:h.map((n,v)=>e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"card border border-primary border-opacity-25",children:e.jsx("div",{className:"card-body p-2",children:e.jsxs("div",{className:"row g-2 align-items-end",children:[e.jsx("div",{className:"col-md-4",children:e.jsxs("select",{className:"form-select",value:n.item_id,onChange:p=>N(v,"item_id",p.target.value),children:[e.jsx("option",{value:"",children:"Item"}),Y.map(p=>e.jsxs("option",{value:p.id,children:[p.name," (Stock: ",p.total_on_hand||0,")"]},p.id))]})}),e.jsx("div",{className:"col-md-2",children:e.jsx("input",{type:"number",step:"1",min:"0",className:"form-control",value:n.quantity,onChange:p=>N(v,"quantity",p.target.value),placeholder:"Quantity"})}),e.jsx("div",{className:"col-md-4",children:e.jsx("input",{type:"text",className:"form-control",value:n.notes,onChange:p=>N(v,"notes",p.target.value),placeholder:"Notes"})}),e.jsx("div",{className:"col-md-2",children:e.jsxs("button",{type:"button",onClick:()=>R(v),className:"btn btn-outline-danger w-100",title:"Remove item",style:{minHeight:"38px"},children:[e.jsx("i",{className:"fas fa-trash me-1"}),"Remove Item"]})})]})})})},v))}):e.jsxs("div",{className:"text-center py-4 text-muted",children:[e.jsx("i",{className:"fas fa-boxes fa-3x mb-3 text-primary opacity-50"}),e.jsx("p",{className:"mb-0",children:"No stock items added yet"}),e.jsx("small",{children:'Click "Add Item" to start consuming stock'})]}),e.jsx("div",{className:"mt-3 text-center",children:e.jsxs("button",{type:"button",onClick:x,className:"btn btn-primary",style:{minWidth:"120px"},children:[e.jsx("i",{className:"fas fa-plus me-2"}),"Add Item"]})}),e.jsx("hr",{className:"my-4"}),e.jsxs("div",{className:"alert alert-info py-2 mb-3",children:[e.jsx("i",{className:"fas fa-info-circle me-2"}),e.jsx("strong",{children:"Additional Items:"})," Select items that patients can purchase separately (not included in procedure)"]}),e.jsx("div",{className:"card border-warning",children:e.jsxs("div",{className:"card-body p-2",children:[e.jsx("div",{className:"row",children:Y.filter(n=>n.is_sellable&&n.patient_price).map(n=>{var v;return e.jsxs("div",{className:"col-12 mb-2",children:[e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",checked:L.some(p=>p.item_id===n.id),onChange:()=>V(n.id,n),id:`billable-${n.id}`}),e.jsxs("label",{className:"form-check-label",htmlFor:`billable-${n.id}`,children:[n.name," - ₱",Number(n.patient_price).toLocaleString()]})]}),L.some(p=>p.item_id===n.id)&&e.jsx("div",{className:"ms-4 mt-1",children:e.jsxs("div",{className:"input-group input-group-sm",style:{width:"150px"},children:[e.jsx("span",{className:"input-group-text",children:"Qty:"}),e.jsx("input",{type:"number",className:"form-control",min:"1",value:((v=L.find(p=>p.item_id===n.id))==null?void 0:v.quantity)||1,onChange:p=>he(n.id,p.target.value)})]})})]},n.id)})}),Y.filter(n=>n.is_sellable&&n.patient_price).length===0&&e.jsx("p",{className:"text-muted mb-0 small",children:"No billable items available. Configure items as sellable in inventory settings."})]})})]})]}),r===2&&e.jsxs("div",{className:"card border-0 shadow-sm",children:[e.jsx("div",{className:"card-header bg-gradient bg-light py-2",children:e.jsxs("h6",{className:"card-title mb-0",children:[e.jsx("i",{className:"fas fa-sticky-note text-primary me-2"}),"Visit Documentation"]})}),e.jsxs("div",{className:"card-body p-3",children:[H&&e.jsxs("div",{className:"alert alert-info mb-3 py-2 border-0",children:[e.jsxs("h6",{className:"alert-heading small",children:[e.jsx("i",{className:"fas fa-info-circle me-2"}),"Original Notes Information"]}),e.jsxs("p",{className:"mb-1 small",children:[e.jsx("strong",{children:"Created by:"})," ",H.created_by," on ",new Date(H.created_at).toLocaleString()]}),H.updated_by&&H.updated_at&&e.jsxs("p",{className:"mb-1 small",children:[e.jsx("strong",{children:"Last updated by:"})," ",H.updated_by," on ",new Date(H.updated_at).toLocaleString()]}),e.jsx("hr",{className:"my-2"}),e.jsx("p",{className:"mb-0 small",children:"You can edit these notes as needed for the final documentation."})]}),e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-user-md text-primary me-1"}),"Dentist Notes"]}),e.jsx("textarea",{className:"form-control",rows:"3",value:se,onChange:n=>_(n.target.value),placeholder:"Enter dentist's notes about the visit..."})]}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-search text-primary me-1"}),"Findings"]}),e.jsx("textarea",{className:"form-control",rows:"3",value:f,onChange:n=>le(n.target.value),placeholder:"Document any findings or observations..."})]}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-clipboard-list text-primary me-1"}),"Treatment Plan"]}),e.jsx("textarea",{className:"form-control",rows:"3",value:i,onChange:n=>F(n.target.value),placeholder:"Outline the treatment plan or follow-up instructions..."})]}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-tooth text-primary me-1"}),"Teeth Treated"]}),e.jsx("input",{type:"text",className:"form-control",value:T,onChange:n=>M(n.target.value),placeholder:"e.g., 1,2,3,4,5 or leave blank if not applicable"}),e.jsx("div",{className:"form-text",children:"Enter tooth numbers separated by commas (e.g., 1,2,3,4,5). Use the Universal Numbering System."})]})]})]})]}),r===3&&e.jsxs("div",{className:"card border-0 shadow-sm",children:[e.jsx("div",{className:"card-header bg-gradient bg-light py-2",children:e.jsxs("h6",{className:"card-title mb-0",children:[e.jsx("i",{className:"fas fa-credit-card text-primary me-2"}),"Payment Verification"]})}),e.jsx("div",{className:"card-body p-3",children:e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"card border-0 shadow-sm",style:{background:"linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)"},children:e.jsxs("div",{className:"card-body p-3",children:[e.jsxs("h6",{className:"card-title text-dark mb-3",children:[e.jsx("i",{className:"fas fa-receipt text-primary me-2"}),"Payment Summary"]}),e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Service"}),e.jsx("div",{className:"fw-semibold text-dark",children:((Ie=o.service)==null?void 0:Ie.name)||"N/A"})]})}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Service Price"}),e.jsxs("div",{className:"fw-semibold text-primary",children:["₱",K.toLocaleString(),ae&&e.jsx("small",{className:"text-info d-block",children:"per tooth"})]})]})}),ge>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-12",children:[e.jsx("hr",{className:"my-2"}),e.jsx("div",{className:"fw-semibold mb-2",children:"Additional Items:"}),L.map(n=>{const v=Y.find(p=>p.id===n.item_id);return e.jsxs("div",{className:"d-flex justify-content-between mb-1",children:[e.jsxs("small",{children:[v==null?void 0:v.name," (x",n.quantity,")"]}),e.jsxs("small",{className:"fw-semibold",children:["₱",Number(n.unit_price*n.quantity).toLocaleString()]})]},n.item_id)}),e.jsx("hr",{className:"my-2"})]}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Additional Charges"}),e.jsxs("div",{className:"fw-semibold text-warning",children:["₱",ge.toLocaleString()]})]})}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Total Price"}),e.jsxs("div",{className:"fw-bold text-primary",children:["₱",Z.toLocaleString()]})]})})]}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Total Paid"}),e.jsxs("div",{className:"fw-semibold text-success",children:["₱",pe.toLocaleString()]})]})}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Balance"}),e.jsxs("div",{className:`fw-bold ${je>0?"text-warning":"text-success"}`,children:["₱",je.toLocaleString()]})]})})]})]})})}),ie&&e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"alert alert-success border-0 shadow-sm",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("i",{className:"fas fa-check-circle fa-2x text-success me-3"}),e.jsxs("div",{children:[e.jsxs("h6",{className:"alert-heading mb-1",children:[e.jsx("i",{className:"fas fa-credit-card me-2"}),"Maya Payment Completed"]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Amount Paid:"})," ₱",Number(Ce.amount_paid||0).toLocaleString()]}),e.jsxs("p",{className:"mb-0",children:[e.jsx("strong",{children:"Payment Date:"})," ",new Date(Ce.paid_at).toLocaleString()]}),e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"fas fa-lock me-1"}),"Payment information is read-only as the Maya payment has been successfully completed."]})]})]})})}),ge>0&&!ie&&e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"alert alert-warning border-0 shadow-sm",children:e.jsxs("div",{className:"d-flex align-items-start",children:[e.jsx("i",{className:"fas fa-exclamation-triangle fa-2x text-warning me-3"}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("h6",{className:"alert-heading mb-1",children:[e.jsx("i",{className:"fas fa-info-circle me-2"}),"Additional Items Selected"]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Additional Charges:"})," ₱",ge.toLocaleString()]}),e.jsxs("p",{className:"mb-0 small",children:[e.jsx("i",{className:"fas fa-lightbulb me-1"}),e.jsx("strong",{children:"HMO/Maya payments only cover the service amount."}),` If the patient's HMO/Maya payment doesn't cover additional charges, select "Partially Paid" and enter the on-site payment amount for the additional items.`]})]})]})})}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-credit-card text-primary me-1"}),"Payment Status"]}),e.jsxs("select",{className:"form-select",value:ne,onChange:n=>Ne(n.target.value),disabled:ie,children:[e.jsx("option",{value:"paid",children:"Fully Paid"}),e.jsx("option",{value:"hmo_fully_covered",children:"HMO Fully Covered"}),e.jsx("option",{value:"partial",children:"Partially Paid (HMO didn't cover all)"}),e.jsx("option",{value:"unpaid",children:"Unpaid (Maya failed)"})]}),ie&&e.jsxs("div",{className:"form-text text-muted",children:[e.jsx("i",{className:"fas fa-lock me-1"}),"Payment status cannot be changed as Maya payment is already completed."]})]}),ne==="partial"&&!ie&&e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-money-bill text-primary me-1"}),"On-site Payment Amount (₱)"]}),e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:"₱"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:je,className:"form-control",value:de,onChange:n=>Se(n.target.value),placeholder:`Maximum: ${je.toLocaleString()}`})]}),e.jsxs("div",{className:"form-text",children:["Maximum amount: ₱",je.toLocaleString()]})]}),ne==="unpaid"&&!ie&&e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-exchange-alt text-primary me-1"}),"Payment Method Change"]}),e.jsxs("select",{className:"form-select",value:ee,onChange:n=>ke(n.target.value),children:[e.jsx("option",{value:"",children:"Select change"}),e.jsx("option",{value:"maya_to_cash",children:"Change Maya to Cash Payment"})]})]})]})})]})]}),e.jsx("div",{className:"modal-footer bg-light border-top flex-shrink-0 py-3",style:{position:"sticky",bottom:0,zIndex:1,backgroundColor:"#f8f9fa"},children:e.jsxs("div",{className:"d-flex justify-content-between w-100 align-items-center",children:[e.jsx("div",{children:r>1&&e.jsxs("button",{type:"button",onClick:()=>A(r-1),className:"btn btn-outline-secondary",style:{minWidth:"100px"},children:[e.jsx("i",{className:"fas fa-arrow-left me-2"}),"Previous"]})}),e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs("small",{className:"text-muted me-3",children:["Step ",r," of 3"]}),r<3?e.jsxs("button",{type:"button",onClick:()=>A(r+1),className:"btn btn-primary",style:{minWidth:"100px"},children:["Next",e.jsx("i",{className:"fas fa-arrow-right ms-2"})]}):e.jsx("button",{type:"button",onClick:be,disabled:q,className:"btn btn-success",style:{minWidth:"140px"},children:q?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Completing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-check me-2"}),"Complete Visit"]})})]})]})})]})})}),ue&&e.jsx("div",{className:"modal fade show d-block",style:{backgroundColor:"rgba(0,0,0,0.65)",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1060,display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem"},tabIndex:"-1",role:"dialog",children:e.jsx("div",{className:"modal-dialog",role:"document",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header bg-warning text-dark",children:[e.jsxs("h5",{className:"modal-title fw-bold",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"No Consumables Recorded"]}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>{B(!1),j(null)},"aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("p",{children:"You are about to complete this visit without logging any inventory items. This will finalize the visit without reducing stock levels."}),e.jsx("p",{className:"mb-0 fw-semibold",children:"If items were used, please record them before continuing. Do you still want to complete the visit?"})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{B(!1),j(null)},children:"Cancel"}),e.jsx("button",{type:"button",className:"btn btn-warning",onClick:async()=>{B(!1),J(!0),te&&await re(te)},disabled:q,children:"Complete Without Items"})]})]})})})]})}function Hs({visit:o,onClose:C}){var P,L;const[y,r]=a.useState(""),[A,Y]=a.useState(!1),[W,h]=a.useState(""),[I,G]=a.useState(null),U=async E=>{var se,_;E.preventDefault(),Y(!0),h("");try{const f=await w.post(`/api/visits/${o.id}/view-notes`,{password:y});G(f.data.notes)}catch(f){h(((_=(se=f==null?void 0:f.response)==null?void 0:se.data)==null?void 0:_.message)||"Invalid password or failed to decrypt notes")}finally{Y(!1)}},q=E=>E?e.jsxs("div",{className:"space-y-4",children:[E.dentist_notes&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Dentist Notes:"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded border",children:e.jsx("p",{className:"whitespace-pre-wrap",children:E.dentist_notes})})]}),E.findings&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Findings:"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded border",children:e.jsx("p",{className:"whitespace-pre-wrap",children:E.findings})})]}),E.treatment_plan&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Treatment Plan:"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded border",children:e.jsx("p",{className:"whitespace-pre-wrap",children:E.treatment_plan})})]}),e.jsxs("div",{className:"text-sm text-gray-600 border-t pt-3",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Completed by:"})," Staff ID #",E.completed_by]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Completed at:"})," ",new Date(E.completed_at).toLocaleString()]})]})]}):null;return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",style:{padding:"1rem"},children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[calc(100vh-2rem)] flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 flex-shrink-0 sticky top-0 bg-white border-b z-10",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h2",{className:"text-xl font-bold",children:["Visit Notes - ",(P=o.patient)==null?void 0:P.first_name," ",(L=o.patient)==null?void 0:L.last_name]}),e.jsx("button",{onClick:C,className:"text-gray-500 hover:text-gray-700",children:"✕"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto overflow-x-hidden p-6",style:{minHeight:0},children:I?e.jsx("div",{children:q(I)}):e.jsxs("form",{onSubmit:U,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Enter your password to view encrypted notes:"}),e.jsx("input",{type:"password",className:"w-full border rounded px-3 py-2",value:y,onChange:E=>r(E.target.value),placeholder:"Enter your account password",required:!0}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"This action will be logged for security purposes."})]}),W&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded",children:W}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:C,className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:A||!y.trim(),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50",children:A?"Verifying...":"View Notes"})]})]})}),I&&e.jsx("div",{className:"p-6 flex-shrink-0 sticky bottom-0 bg-white border-t z-10",children:e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:C,className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:"Close"})})})]})})}function $s({visit:o,onClose:C,onSuccess:y}){var ee,ke,me;const[r,A]=a.useState([]),[Y,W]=a.useState(!0),[h,I]=a.useState(null),[G,U]=a.useState(!1),[q,P]=a.useState(""),[L,E]=a.useState(null),[se,_]=a.useState(!1),[f,le]=a.useState(null),[i,F]=a.useState(!1),[T,M]=a.useState(""),[H,$]=a.useState(null),[ue,B]=a.useState(null),[te,j]=a.useState(!1);a.useEffect(()=>{J()},[]);const xe=c=>{if(!c)return null;if(typeof c.visit_date=="string"&&c.visit_date.length>=10)return c.visit_date.slice(0,10);if(typeof c.start_time=="string"&&c.start_time.length>=10){const g=c.start_time.includes(" ")?c.start_time.replace(" ","T"):c.start_time,b=new Date(g);if(!Number.isNaN(b.getTime()))try{return b.toISOString().slice(0,10)}catch{}const x=c.start_time.split(" ")[0];if(/^\d{4}-\d{2}-\d{2}$/.test(x))return x}return null};a.useEffect(()=>{var be;const c=o!=null&&o.assigned_dentist?{id:o.assigned_dentist.id??null,name:o.assigned_dentist.dentist_name||o.assigned_dentist.dentist_code||null,code:o.assigned_dentist.dentist_code??null}:null,g=xe(o),b=g?(()=>{const re=new Date(g);if(!Number.isNaN(re.getTime()))try{return re.toISOString().slice(0,10)}catch{}return g})():null,x=new Date,N=new Date(x.getTime()-x.getTimezoneOffset()*6e4).toISOString().slice(0,10),R=b||N;if(!!!((be=o==null?void 0:o.patient)!=null&&be.id)){le(c),M(c?"":"Recent dentist: —");return}(async()=>{var re,pe,Ae;F(!0),M("");try{let K=null;try{K=((re=(await w.get(`/api/patients/${o.patient.id}/preferred-dentist`,R?{params:{reference_date:R}}:void 0)).data)==null?void 0:re.preferred_dentist)??null}catch(ae){console.error("Preferred dentist endpoint failed:",ae)}if(!K&&R)try{const ae=new URLSearchParams({date:R,with_meta:"1",patient_id:String(o.patient.id)}),Z=((Ae=(pe=(await w.get(`/api/appointment/available-services?${ae.toString()}`)).data)==null?void 0:pe.metadata)==null?void 0:Ae.preferred_dentist)??null;Z&&(K={id:Z.id??null,name:Z.name||Z.dentist_name||Z.code||Z.dentist_code||null,code:Z.code||Z.dentist_code||null})}catch(ae){console.error("Available services metadata lookup failed:",ae)}!K&&c&&(K=c),le(K),K||M("Recent dentist: —")}catch(K){console.error("Failed to resolve preferred dentist:",K),c?(le(c),M("")):(le(null),M("Recent dentist: —"))}finally{F(!1)}})()},[o]),a.useEffect(()=>{let c=!1;return(async()=>{if(!(o!=null&&o.appointment_id)){$(null),B(null);return}j(!0);try{const b=await ne();if(c)return;const x=b==null?void 0:b.find(he=>he.id===o.appointment_id);if(!x){$(null),B(null);return}const N=!!x.honor_preferred_dentist;if($(N),!N){B(null);return}const R=x.dentist_schedule_id;let V=(f==null?void 0:f.name)||(f==null?void 0:f.code)||null;if(!V&&R){const he=r.find(be=>be.id===R);he&&(V=he.dentist_name||he.dentist_code||null)}!V&&(o!=null&&o.assigned_dentist)&&R&&o.assigned_dentist.id===R&&(V=o.assigned_dentist.dentist_name||o.assigned_dentist.dentist_code||null),B(V)}catch(b){console.error("Failed to determine appointment preference:",b),c||($(null),B(null))}finally{c||j(!1)}})(),()=>{c=!0}},[o==null?void 0:o.appointment_id,r,f]);const J=async()=>{W(!0),P("");try{const c=new Date,g=c.getDay(),x=["sun","mon","tue","wed","thu","fri","sat"][g],R=(await w.get("/api/dentists",{params:{status:"active"}})).data.filter(V=>V[x]===!0&&V.status==="active"&&(!V.contract_end_date||new Date(V.contract_end_date)>=c));console.log("Available dentists:",R),A(R)}catch(c){console.error("Failed to fetch dentists:",c),P("Failed to load available dentists. Please try again.")}finally{W(!1)}},ne=async()=>{var c;if(L)return L;_(!0);try{const g=await w.get("/api/appointments"),b=Array.isArray(g.data)?g.data:((c=g.data)==null?void 0:c.data)||[];return E(b),b}catch(g){return console.error("Failed to load appointments:",g),[]}finally{_(!1)}},Ne=c=>{if(!(c!=null&&c.date)||!(c!=null&&c.time_slot))return null;const[g]=c.time_slot.split("-");if(!g)return null;const b=g.length===5?`${g}:00`:g,x=`${c.date}T${b}`,N=new Date(x);return isNaN(N.getTime())?null:N},de=async()=>{try{const c=await ne();if(!h)return!0;const g=new Date,b=c.filter(x=>x&&x.dentist_schedule_id===h.id&&["pending","approved"].includes(x.status)).map(x=>({appt:x,start:Ne(x)})).find(({start:x})=>{if(!x)return!1;const N=(x.getTime()-g.getTime())/6e4;return N>=0&&N<=60});if(b!=null&&b.start){const x=b.start.toLocaleString(void 0,{hour:"2-digit",minute:"2-digit"});if(!window.confirm(`Dr. ${h.dentist_name||h.dentist_code} already has a dentist-specific appointment at ${x}. Do you still want to send this visit code?`))return!1}if(o!=null&&o.appointment_id){const x=c.find(N=>N.id===o.appointment_id);if(x&&x.honor_preferred_dentist&&x.dentist_schedule_id&&x.dentist_schedule_id!==h.id){const N=r.find(V=>V.id===x.dentist_schedule_id);if(!window.confirm(`This appointment is set to prefer ${(N==null?void 0:N.dentist_name)||(N==null?void 0:N.dentist_code)||"another dentist"}. Send the visit code to Dr. ${h.dentist_name||h.dentist_code} anyway?`))return!1}}return!0}catch(c){return console.error("Warning checks failed:",c),!0}},Se=async()=>{var g,b;if(!h){P("Please select a dentist to send the visit code to.");return}if(!h.email){P("Selected dentist does not have an email address configured.");return}if(await de()){U(!0),P("");try{console.log("Sending visit code to dentist:",h);const x=await w.post("/api/visits/send-visit-code",{visit_id:o.id,dentist_id:h.id,dentist_email:h.email});k.success(`Visit code sent successfully to Dr. ${h.dentist_name||h.dentist_code}!`),y&&y(x.data,h),C()}catch(x){console.error("Failed to send visit code:",x);let N="Failed to send visit code. Please try again.";(b=(g=x.response)==null?void 0:g.data)!=null&&b.message?N=x.response.data.message:x.message&&(N=x.message),P(N)}finally{U(!1)}}};return e.jsx("div",{className:"modal show d-block",tabIndex:"-1",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1050,overflowY:"auto",display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem"},children:e.jsx("div",{className:"modal-dialog modal-lg",style:{margin:"0 auto",maxHeight:"calc(100vh - 2rem)",width:"100%"},children:e.jsxs("div",{className:"modal-content",style:{display:"flex",flexDirection:"column",maxHeight:"calc(100vh - 2rem)",overflow:"hidden"},children:[e.jsxs("div",{className:"modal-header flex-shrink-0",style:{position:"sticky",top:0,zIndex:1,backgroundColor:"#fff",borderBottom:"1px solid #dee2e6"},children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-send me-2"}),"Send Visit Code to Dentist"]}),e.jsx("button",{className:"btn-close",onClick:C,disabled:G})]}),e.jsxs("div",{className:"modal-body flex-grow-1",style:{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:0},children:[e.jsxs("div",{className:"alert alert-info mb-4",children:[e.jsxs("h6",{className:"alert-heading",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),"Visit Information"]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("strong",{children:"Patient:"})," ",(ee=o.patient)==null?void 0:ee.first_name," ",(ke=o.patient)==null?void 0:ke.last_name]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("strong",{children:"Visit Code:"}),e.jsx("span",{className:"badge bg-primary ms-2 fs-6",children:o.visit_code})]}),e.jsxs("div",{className:"col-md-6 mt-2",children:[e.jsx("strong",{children:"Service:"})," ",((me=o.service)==null?void 0:me.name)||"Not specified"]}),e.jsxs("div",{className:"col-md-6 mt-2",children:[e.jsx("strong",{children:"Started:"})," ",new Date(o.start_time).toLocaleString()]}),i?e.jsx("div",{className:"col-12 mt-2",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-hourglass-split me-1"}),"Checking recent dentist…"]})}):f?e.jsxs("div",{className:"col-md-6 mt-2",children:[e.jsx("strong",{children:"Recent Dentist:"})," ",f.name||f.code]}):null,te?e.jsx("div",{className:"col-12 mt-2",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-hourglass me-1"}),"Checking appointment preference…"]})}):H!==null?e.jsxs("div",{className:"col-md-6 mt-2",children:[e.jsx("strong",{children:"Appointment preference:"})," ",H?"Honor recent dentist":"Any available dentist",H&&ue&&e.jsxs("div",{className:"small text-muted",children:["Preferred: ",ue]})]}):null]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"bi bi-person-badge me-2"}),"Select Available Dentist Today"]}),Y?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"mt-2 text-muted",children:"Loading available dentists..."})]}):q&&!r.length?e.jsxs("div",{className:"alert alert-danger",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),q]}):r.length===0?e.jsxs("div",{className:"alert alert-warning",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"No dentists are scheduled to work today. Please check the dentist schedule."]}):e.jsx("div",{className:"row",children:r.map(c=>e.jsx("div",{className:"col-md-6 mb-3",children:e.jsx("div",{className:`card h-100 cursor-pointer border-2 ${(h==null?void 0:h.id)===c.id?"border-primary bg-light":"border-light"}`,style:{cursor:"pointer",transition:"all 0.2s ease"},onClick:()=>I(c),onMouseEnter:g=>{(h==null?void 0:h.id)!==c.id&&(g.target.style.borderColor="#0d6efd",g.target.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)")},onMouseLeave:g=>{(h==null?void 0:h.id)!==c.id&&(g.target.style.borderColor="#e9ecef",g.target.style.boxShadow="none")},children:e.jsx("div",{className:"card-body p-3",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("div",{className:"me-3",children:e.jsx("div",{className:"bg-primary text-white rounded-circle d-flex align-items-center justify-content-center",style:{width:"40px",height:"40px"},children:e.jsx("i",{className:"bi bi-person-fill"})})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("h6",{className:"card-title mb-1",children:["Dr. ",c.dentist_name||c.dentist_code]}),e.jsxs("small",{className:"text-muted",children:[c.dentist_code&&e.jsx("span",{className:"badge bg-secondary me-2",children:c.dentist_code}),c.employment_type&&e.jsx("span",{className:"text-capitalize",children:c.employment_type.replace("_"," ")})]}),c.email&&e.jsx("div",{className:"mt-1",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-envelope me-1"}),c.email]})})]}),(h==null?void 0:h.id)===c.id&&e.jsx("div",{className:"text-primary",children:e.jsx("i",{className:"bi bi-check-circle-fill fs-5"})})]})})})},c.id))})]}),q&&e.jsxs("div",{className:"alert alert-danger",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),q]})]}),e.jsxs("div",{className:"modal-footer flex-shrink-0",style:{position:"sticky",bottom:0,zIndex:1,backgroundColor:"#fff",borderTop:"1px solid #dee2e6"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:C,disabled:G,children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:Se,disabled:G||se||!h||r.length===0,children:G?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-send me-2"}),"Send Visit Code"]})})]})]})})})}const rs=o=>{if(!o)return"";const C=new Date(o);if(Number.isNaN(C.getTime()))return"";const y=new Date;let r=y.getFullYear()-C.getFullYear();const A=y.getMonth()-C.getMonth();return(A<0||A===0&&y.getDate()<C.getDate())&&(r-=1),r<0?0:r>150?150:r},cs=o=>{if(o===""||o===null||o===void 0)return"";const C=Number(o);if(Number.isNaN(C))return"";const y=Math.round(C);return y<0?0:y>150?150:y};function Rs({visit:o,onClose:C,onSuccess:y}){const[r,A]=a.useState({}),[Y,W]=a.useState(!0),[h,I]=a.useState(!1),[G,U]=a.useState(""),[q,P]=a.useState(!1),[L,E]=a.useState(null);a.useEffect(()=>{se()},[o]);const se=async()=>{var i,F;W(!0),U("");try{const T=await w.get(`/api/visits/${o.id}/medical-history-form`),M=T.data.form_data||{},H=rs(M.date_of_birth),$=H!==""?H:cs(M.age);A({...M,age:$}),P(T.data.previous_history_exists||!1),E(T.data.previous_history_date||null)}catch(T){console.error("Failed to load medical history form:",T),U(((F=(i=T.response)==null?void 0:i.data)==null?void 0:F.message)||"Failed to load form data. Please try again.")}finally{W(!1)}},_=(i,F)=>{if(i==="date_of_birth"){const T=rs(F);A(M=>({...M,date_of_birth:F,age:F?T===""?"":T:""}));return}if(i==="age"){A(T=>({...T,age:cs(F)}));return}A(T=>({...T,[i]:F}))},f=(i,F)=>{A(T=>({...T,[i]:F}))},le=async i=>{var F,T,M,H;i.preventDefault(),I(!0),U("");try{const $=await w.post(`/api/visits/${o.id}/medical-history`,r);k.success(`Medical history completed successfully!

Visit Code: ${$.data.visit.visit_code}

You can now send this code to the dentist.`),y&&y($.data),C()}catch($){if(console.error("Failed to submit medical history:",$),(T=(F=$.response)==null?void 0:F.data)!=null&&T.errors){const ue=Object.values($.response.data.errors).flat().join(`
`);U(ue)}else U(((H=(M=$.response)==null?void 0:M.data)==null?void 0:H.message)||"Failed to submit medical history. Please try again.")}finally{I(!1)}};return Y?e.jsx("div",{className:"modal show d-block",tabIndex:"-1",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1050},children:e.jsx("div",{className:"modal-dialog modal-xl modal-dialog-scrollable",style:{margin:"1rem auto",maxHeight:"calc(100vh - 2rem)"},children:e.jsx("div",{className:"modal-content",children:e.jsxs("div",{className:"modal-body text-center py-5",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"mt-3",children:"Loading medical history form..."})]})})})}):e.jsx("div",{className:"modal show d-block",tabIndex:"-1",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1050,display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem"},children:e.jsx("div",{className:"modal-dialog modal-xl modal-dialog-scrollable",style:{margin:"1rem auto",maxHeight:"calc(100vh - 2rem)"},children:e.jsxs("div",{className:"modal-content",style:{maxHeight:"calc(100vh - 2rem)",display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs("div",{className:"modal-header flex-shrink-0",style:{position:"sticky",top:0,zIndex:1,backgroundColor:"#fff"},children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-file-medical me-2"}),"Dental and Medical History Form"]}),e.jsx("button",{className:"btn-close",onClick:C,disabled:h})]}),e.jsxs("form",{onSubmit:le,style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("div",{className:"modal-body",style:{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:0},children:[q&&e.jsxs("div",{className:"alert alert-info",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),e.jsx("strong",{children:"Previous medical history found."})," Please review and update all information if the patient has visited other clinics or if there have been any changes.",L&&e.jsx("div",{className:"mt-2",children:e.jsxs("small",{children:["Last completed: ",new Date(L).toLocaleDateString()]})})]}),G&&e.jsxs("div",{className:"alert alert-danger",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),G]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-primary text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-person me-2"}),"Patient Information"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Full Name *"}),e.jsx("input",{type:"text",className:"form-control",value:r.full_name||"",onChange:i=>_("full_name",i.target.value),required:!0})]}),e.jsxs("div",{className:"col-md-3 mb-3",children:[e.jsx("label",{className:"form-label",children:"Age"}),e.jsx("input",{type:"number",className:"form-control",value:r.age||"",onChange:i=>_("age",i.target.value),min:"0",max:"150"})]}),e.jsxs("div",{className:"col-md-3 mb-3",children:[e.jsx("label",{className:"form-label",children:"Sex"}),e.jsxs("select",{className:"form-select",value:r.sex||"",onChange:i=>_("sex",i.target.value),children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"male",children:"Male"}),e.jsx("option",{value:"female",children:"Female"})]})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Address"}),e.jsx("input",{type:"text",className:"form-control",value:r.address||"",onChange:i=>_("address",i.target.value)})]}),e.jsxs("div",{className:"col-md-3 mb-3",children:[e.jsx("label",{className:"form-label",children:"Contact Number"}),e.jsx("input",{type:"text",className:"form-control",value:r.contact_number||"",onChange:i=>_("contact_number",i.target.value)})]}),e.jsxs("div",{className:"col-md-3 mb-3",children:[e.jsx("label",{className:"form-label",children:"Date of Birth"}),e.jsx("input",{type:"date",className:"form-control",value:r.date_of_birth||"",onChange:i=>_("date_of_birth",i.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Occupation"}),e.jsx("input",{type:"text",className:"form-control",value:r.occupation||"",onChange:i=>_("occupation",i.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Email"}),e.jsx("input",{type:"email",className:"form-control",value:r.email||"",onChange:i=>_("email",i.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Previous Dentist"}),e.jsx("input",{type:"text",className:"form-control",value:r.previous_dentist||"",onChange:i=>_("previous_dentist",i.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Last Dental Visit"}),e.jsx("input",{type:"date",className:"form-control",value:r.last_dental_visit||"",onChange:i=>_("last_dental_visit",i.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Physician Name"}),e.jsx("input",{type:"text",className:"form-control",value:r.physician_name||"",onChange:i=>_("physician_name",i.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Physician Address"}),e.jsx("input",{type:"text",className:"form-control",value:r.physician_address||"",onChange:i=>_("physician_address",i.target.value)})]})]})})]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-primary text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-heart-pulse me-2"}),"Health Questions"]})}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.in_good_health||!1,onChange:i=>f("in_good_health",i.target.checked)}),"Are you in good health?"]})}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.under_medical_treatment||!1,onChange:i=>f("under_medical_treatment",i.target.checked)}),"Are you under medical treatment now?"]}),r.under_medical_treatment&&e.jsx("textarea",{className:"form-control mt-2",rows:"2",placeholder:"Please provide details...",value:r.medical_treatment_details||"",onChange:i=>_("medical_treatment_details",i.target.value)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.serious_illness_surgery||!1,onChange:i=>f("serious_illness_surgery",i.target.checked)}),"Have you had any serious illness or operation?"]}),r.serious_illness_surgery&&e.jsx("textarea",{className:"form-control mt-2",rows:"2",placeholder:"Please provide details...",value:r.illness_surgery_details||"",onChange:i=>_("illness_surgery_details",i.target.value)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.hospitalized||!1,onChange:i=>f("hospitalized",i.target.checked)}),"Have you been hospitalized in the past 2 years?"]}),r.hospitalized&&e.jsx("textarea",{className:"form-control mt-2",rows:"2",placeholder:"Please provide details...",value:r.hospitalization_details||"",onChange:i=>_("hospitalization_details",i.target.value)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.taking_medications||!1,onChange:i=>f("taking_medications",i.target.checked)}),"Are you taking any medications?"]}),r.taking_medications&&e.jsx("textarea",{className:"form-control mt-2",rows:"2",placeholder:"Please list all medications...",value:r.medications_list||"",onChange:i=>_("medications_list",i.target.value)})]}),e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.uses_tobacco||!1,onChange:i=>f("uses_tobacco",i.target.checked)}),"Do you use tobacco?"]})}),e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.uses_alcohol_drugs||!1,onChange:i=>f("uses_alcohol_drugs",i.target.checked)}),"Do you use alcohol or drugs?"]})})]})]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-danger text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"Allergies"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.allergic_local_anesthetic||!1,onChange:i=>f("allergic_local_anesthetic",i.target.checked)}),"Local Anesthetic"]})}),e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.allergic_penicillin||!1,onChange:i=>f("allergic_penicillin",i.target.checked)}),"Penicillin"]})}),e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.allergic_sulfa||!1,onChange:i=>f("allergic_sulfa",i.target.checked)}),"Sulfa Drugs"]})}),e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.allergic_aspirin||!1,onChange:i=>f("allergic_aspirin",i.target.checked)}),"Aspirin"]})}),e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.allergic_latex||!1,onChange:i=>f("allergic_latex",i.target.checked)}),"Latex"]})}),e.jsxs("div",{className:"col-md-12 mb-3",children:[e.jsx("label",{className:"form-label",children:"Other Allergies"}),e.jsx("textarea",{className:"form-control",rows:"2",placeholder:"Please specify...",value:r.allergic_others||"",onChange:i=>_("allergic_others",i.target.value)})]})]})})]}),r.sex==="female"&&e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-info text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-gender-female me-2"}),"For Women Only"]})}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.is_pregnant||!1,onChange:i=>f("is_pregnant",i.target.checked)}),"Are you pregnant?"]})}),e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.is_nursing||!1,onChange:i=>f("is_nursing",i.target.checked)}),"Are you nursing?"]})}),e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r.taking_birth_control||!1,onChange:i=>f("taking_birth_control",i.target.checked)}),"Are you taking birth control pills?"]})})]})]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-success text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-clipboard-pulse me-2"}),"Vital Information"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-4 mb-3",children:[e.jsx("label",{className:"form-label",children:"Blood Type"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"e.g., O+, A-, etc.",value:r.blood_type||"",onChange:i=>_("blood_type",i.target.value)})]}),e.jsxs("div",{className:"col-md-4 mb-3",children:[e.jsx("label",{className:"form-label",children:"Blood Pressure"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"e.g., 120/80",value:r.blood_pressure||"",onChange:i=>_("blood_pressure",i.target.value)})]}),e.jsxs("div",{className:"col-md-4 mb-3",children:[e.jsx("label",{className:"form-label",children:"Bleeding Time"}),e.jsx("input",{type:"text",className:"form-control",value:r.bleeding_time||"",onChange:i=>_("bleeding_time",i.target.value)})]})]})})]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-warning text-dark",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-clipboard2-pulse me-2"}),"Medical Conditions"]})}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"row",children:["high_blood_pressure","low_blood_pressure","heart_disease","heart_murmur","chest_pain","stroke","diabetes","hepatitis","tuberculosis","kidney_disease","cancer","asthma","anemia","arthritis","epilepsy","aids_hiv","stomach_troubles","thyroid_problems","hay_fever","head_injuries","rapid_weight_loss","joint_replacement","radiation_therapy","swollen_ankles"].map(i=>e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:r[i]||!1,onChange:F=>f(i,F.target.checked)}),i.split("_").map(F=>F.charAt(0).toUpperCase()+F.slice(1)).join(" ")]})},i))}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"form-label",children:"Other Conditions"}),e.jsx("textarea",{className:"form-control",rows:"3",placeholder:"Please specify any other medical conditions...",value:r.other_conditions||"",onChange:i=>_("other_conditions",i.target.value)})]})]})]})]}),e.jsxs("div",{className:"modal-footer flex-shrink-0",style:{position:"sticky",bottom:0,backgroundColor:"#fff",borderTop:"1px solid #dee2e6"},children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:C,disabled:h,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:h,children:h?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),"Submit Medical History"]})})]})]})]})})})}function Os({show:o,onClose:C}){const[y,r]=a.useState(!1),[A,Y]=a.useState(null);a.useEffect(()=>{o&&W()},[o]);const W=async()=>{r(!0);try{const h=await w.get("/api/staff/today-time-blocks");Y(h.data)}catch(h){console.error("Failed to fetch time blocks:",h),k.error("Failed to load time blocks")}finally{r(!1)}};return o?e.jsx("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"},children:e.jsx("div",{className:"modal-dialog modal-xl modal-dialog-scrollable",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header bg-primary text-white",children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-calendar-check me-2"}),"Today's Appointment Schedule"]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:C})]}),e.jsx("div",{className:"modal-body",children:y?e.jsx("div",{className:"text-center py-5",children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}):A!=null&&A.is_open?e.jsxs("div",{children:[e.jsxs("div",{className:"alert alert-info mb-4",children:[e.jsx("strong",{children:"Clinic Hours:"})," ",A.open_time," - ",A.close_time," |",e.jsx("strong",{className:"ms-3",children:"Capacity:"})," ",A.capacity," per slot"]}),e.jsx("div",{className:"time-block-container",children:A.blocks.map(h=>e.jsxs("div",{className:`card mb-3 ${h.count>0?"border-primary":"border-secondary"}`,children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-clock me-2"}),h.time]}),e.jsxs("span",{className:`badge ${h.count>0?"bg-primary":"bg-secondary"}`,children:[h.count," appointment",h.count!==1?"s":""]})]}),h.count>0&&e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"list-group list-group-flush",children:h.appointments.map(I=>e.jsx("div",{className:"list-group-item",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsxs("div",{children:[e.jsx("h6",{className:"mb-1",children:I.patient_name}),e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-bandaid me-1"}),I.service_name]}),e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-tag me-1"}),"Ref: ",I.reference_code]})]}),e.jsx("span",{className:`badge ${I.status==="completed"?"bg-success":"bg-info"}`,children:I.status})]})},I.id))})})]},h.time))})]}):e.jsxs("div",{className:"alert alert-info",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),"Clinic is closed today"]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:C,children:"Close"}),e.jsxs("button",{type:"button",className:"btn btn-primary",onClick:W,disabled:y,children:[e.jsx("i",{className:"bi bi-arrow-clockwise me-2"}),"Refresh"]})]})]})})}):null}const zs=260;function Zs({initialVisitType:o,initialRefCode:C}){const[y,r]=a.useState([]),[A,Y]=a.useState(!1),[W,h]=a.useState(!1),[I,G]=a.useState("walkin"),[U,q]=a.useState(""),[P,L]=a.useState(null),[E,se]=a.useState(!1),[_,f]=a.useState(""),[le,i]=a.useState(!1),[F,T]=a.useState(null),[M,H]=a.useState(""),[$,ue]=a.useState(!1),[B,te]=a.useState(null),[j,xe]=a.useState({patient_id:"",first_name:"",last_name:"",contact:"",service_id:""}),[J,ne]=a.useState("existing"),[Ne,de]=a.useState(""),[Se,ee]=a.useState([]),[ke,me]=a.useState(!1),[c,g]=a.useState(null),b=a.useRef(null),[x,N]=a.useState({first_name:"",last_name:"",contact:""}),[R,V]=a.useState([]),[he,be]=a.useState(""),[re,pe]=a.useState([]),[Ae,K]=a.useState(null),[ae,ge]=a.useState(!1),[Z,je]=a.useState(null),[Ce,ie]=a.useState(null),[Fe,De]=a.useState(null),[Te,Me]=a.useState(null),Ie=Es(),n=a.useRef(null),[v,p]=a.useState([]),[S,O]=a.useState(!1),[os,He]=a.useState(!1),[ds,$e]=a.useState(!1),[We,Re]=a.useState(null),[ms,Ue]=a.useState(!1),[l,z]=a.useState({patient_id:"",first_name:"",last_name:"",contact_number:"",email:"",birthdate:"",service_id:"",date:"",start_time:"",payment_method:"cash",patient_hmo_id:"",teeth_count:"",linkToExisting:!1,honor_preferred_dentist:!0}),[Qe,ve]=a.useState([]),[hs,Ke]=a.useState(!1),[Xe,Ze]=a.useState(!1),[Q,qe]=a.useState(null),Ge=s=>{if(!s||typeof s!="object")return s;const t=["per_teeth_service","per_tooth_service","requires_teeth_count"],d={...s};return t.forEach(m=>{m in d&&(d[m]=!!d[m])}),d},us=s=>Array.isArray(s)?s.map(t=>typeof t=="string"?t:t&&typeof t.date=="string"?Object.prototype.hasOwnProperty.call(t,"preferred_dentist_present")&&t.preferred_dentist_present===!1?null:t.date:null).filter(Boolean):[],Je=s=>Array.isArray(s)?s.map(Ge):[],[Le,Oe]=a.useState([]),[xs,es]=a.useState(!1),[ye,Ee]=a.useState(null),[Pe,Ve]=a.useState({dates:[],present:!1}),[_e,we]=a.useState(null),[ps,fs]=a.useState(()=>typeof window<"u"?window.innerHeight:1e3),Be=!!(l.date&&ye&&(Array.isArray(Pe.dates)&&Pe.dates.includes(l.date)||Pe.present===!0));a.useEffect(()=>{fe()},[]),a.useEffect(()=>{if(typeof window>"u")return;const s=()=>fs(window.innerHeight);return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),a.useEffect(()=>{console.log("🔄 Visits state updated:",y),console.log("📊 Visit counts:",{total:y.length,pending:y.filter(s=>s.status==="pending").length,completed:y.filter(s=>s.status==="completed").length,rejected:y.filter(s=>s.status==="rejected").length})},[y]),a.useEffect(()=>{const s=new URLSearchParams(Ie.search),t=s.get("visitType"),d=s.get("refCode"),m=o||t,u=(C||d||"").toUpperCase();m==="appointment"&&(G("appointment"),u&&(q(u),setTimeout(()=>{n.current&&n.current.focus()},0)))},[o,C,Ie.search]),a.useEffect(()=>{if(!B||J!=="existing"){b.current&&(clearTimeout(b.current),b.current=null);return}const s=Ne.trim();if(s.length<2){b.current&&(clearTimeout(b.current),b.current=null),ee([]),me(!1);return}return b.current&&(clearTimeout(b.current),b.current=null),me(!0),b.current=setTimeout(async()=>{try{const t=await w.get("/api/patients/search",{params:{q:s}});ee(t.data||[])}catch(t){console.error("Failed to search patients",t),ee([])}finally{me(!1)}},300),()=>{b.current&&(clearTimeout(b.current),b.current=null)}},[Ne,J,B]);const fe=async()=>{Y(!0);try{console.log("🌐 Fetching visits from API...");const s=await w.get("/api/visits");console.log("📥 API response received:",s.data),console.log("📈 Number of visits received:",s.data.length),console.log("⏳ Visits with pending status:",s.data.filter(t=>t.status==="pending")),console.log("🔍 Visit IDs:",s.data.map(t=>{var d,m;return{id:t.id,status:t.status,patient:((d=t.patient)==null?void 0:d.first_name)+" "+((m=t.patient)==null?void 0:m.last_name)}})),r(s.data)}catch(s){console.error("❌ Failed to load visits",s)}finally{Y(!1)}},bs=async()=>{var s,t;h(!0);try{let d;if(I==="walkin")d={visit_type:"walkin"};else if(I==="appointment"){if(!P){k.error("Search and select a valid appointment first."),h(!1);return}d={visit_type:"appointment",reference_code:(U||"").toUpperCase().replace(/[^A-Z0-9]/g,"")}}console.log("🚀 Creating visit with payload:",d);const m=await w.post("/api/visits",d),u=m.data.visit||m.data;console.log("✅ Visit created successfully:",u),console.log("📋 Visit details:",{id:u.id,status:u.status,visit_code:u.visit_code,patient_id:u.patient_id,patient_name:((s=u.patient)==null?void 0:s.first_name)+" "+((t=u.patient)==null?void 0:t.last_name),start_time:u.start_time}),m.data.requires_medical_history?k("Visit created. Please complete the medical history form before sending the visit code to the dentist.",{icon:"ℹ️"}):u.visit_code&&k.success(`Visit started successfully!

Visit Code: ${u.visit_code}

Share this code with the dentist to begin consultation.`),console.log("➕ Adding new visit to state:",u),r(D=>{const X=[u,...D];return console.log("🔄 Updated visits state with new visit:",X),console.log("🎯 New visit should now be visible in the list"),X}),q(""),L(null),console.log("🔄 Fetching visits after creation to ensure consistency..."),await new Promise(D=>setTimeout(D,200)),await fe(),console.log("✅ Visit creation process completed")}catch(d){console.error("Error creating visit:",d),k.error("Failed to start visit.")}finally{h(!1)}},gs=async(s,t)=>{{const d=y.find(m=>m.id===s);if(!d.service_id){k.error("Please select a service for this patient before finishing the visit. Use the 'Edit' button to assign a service.");return}if(!d.visit_code_sent_at){k.error("Send the visit code to a dentist before completing the visit.");return}je(d);return}},js=async()=>{await fe()},Ns=async s=>{var t,d;De(s);try{const m=await w.post(`/api/receipts/visit/${s}/email`,{},{skip401Handler:!0});m.data.note?k.success(`${m.data.message}

${m.data.note}`):k.success(`Receipt sent successfully to ${m.data.email}`)}catch(m){console.error("Failed to send receipt email",m);const u=((d=(t=m.response)==null?void 0:t.data)==null?void 0:d.message)||"Failed to send receipt email. Please try again.";k.error(u)}finally{De(null)}},vs=async()=>{se(!0),L(null),f("");try{const s=(U||"").toUpperCase().replace(/[^A-Z0-9]/g,"");if(s.length!==8){f("Enter the full 8-character code.");return}const t=await w.get(`/api/appointment/resolve/${s}`);L(t.data)}catch{f("Invalid or used reference code.")}finally{se(!1)}},ys=async s=>{var t,d,m,u,D,X;te(s),ne("existing"),de(((t=s.patient)==null?void 0:t.last_name)||""),ee([]),me(!1),g(s.patient?{...s.patient}:null),N({first_name:"",last_name:"",contact:""}),xe({patient_id:(d=s.patient)!=null&&d.id?String(s.patient.id):"",first_name:((m=s.patient)==null?void 0:m.first_name)||"",last_name:((u=s.patient)==null?void 0:u.last_name)||"",contact:((D=s.patient)==null?void 0:D.contact_number)||((X=s.patient)==null?void 0:X.contact)||"",service_id:s.service_id||""});try{const ce=new Date().toISOString().slice(0,10),oe=await w.get(`/api/appointment/available-services?date=${ce}`),ze=Array.isArray(oe.data)?oe.data:oe.data.data||[];V(Je(ze))}catch{k.error("Failed to load services.")}},_s=s=>{s&&(g(s),xe(t=>({...t,patient_id:s.id?String(s.id):"",first_name:s.first_name||"",last_name:s.last_name||"",contact:s.contact_number||s.contact||""})),de(s.last_name||""),ee([]))},ss=async(s,t)=>{if(te(null),await fe(),!(s!=null&&s.appointment_id)&&t)try{const d=await w.get(`/api/visits/${s.id}`);d.data.medical_history_status==="pending"&&(Re(d.data),$e(!0))}catch(d){console.error("Failed to fetch updated visit for medical history:",d)}},ts=async(s,t,d)=>{var m;(m=s==null?void 0:s.data)!=null&&m.potential_matches&&s.data.potential_matches.length>0?(p(s.data.potential_matches),O(!0)):await ss(t,d)},ws=async()=>{var t,d,m;if(!B)return;const s=B;try{if(J==="existing"){if(c&&c.id&&c.id!==((t=s.patient)==null?void 0:t.id)){const X={target_patient_id:c.id};j.service_id&&(X.service_id=j.service_id),await w.post(`/api/visits/${s.id}/link-existing`,X),await w.put(`/api/visits/${s.id}/update-patient`,{first_name:j.first_name,last_name:j.last_name,contact_number:j.contact.trim()!==""?j.contact.trim():(d=s.patient)==null?void 0:d.contact_number,service_id:j.service_id||null}),await ss(s,j.service_id);return}const D=await w.put(`/api/visits/${s.id}/update-patient`,{first_name:j.first_name,last_name:j.last_name,contact_number:j.contact.trim()!==""?j.contact.trim():(m=s.patient)==null?void 0:m.contact_number,service_id:j.service_id||null});await ts(D,s,j.service_id)}else{const u=await w.put(`/api/visits/${s.id}/update-patient`,{first_name:x.first_name.trim(),last_name:x.last_name.trim(),contact_number:x.contact.trim(),service_id:j.service_id||null});await ts(u,s,j.service_id)}}catch{k.error("Failed to update patient.")}},Ss=s=>{Re(s),$e(!0)},ks=async s=>{await fe(),$e(!1),Re(null)},Cs=async()=>{z({patient_id:"",first_name:"",last_name:"",contact_number:"",email:"",birthdate:"",service_id:"",date:"",start_time:"",payment_method:"cash",patient_hmo_id:"",teeth_count:"",linkToExisting:!1,honor_preferred_dentist:!0}),qe(null),ve([]),Oe([]),Ee(null),Ve({dates:[],present:!1}),we(null),V([]),He(!0)},Ps=async s=>{var t,d,m;if(z(u=>({...u,date:s,start_time:"",service_id:"",teeth_count:"",honor_preferred_dentist:!1})),ve([]),qe(null),we(null),s){es(!0);try{const u=await w.get(`/api/dentists/available-for-date?date=${s}`);Oe(u.data.dentists||[])}catch(u){console.error("Failed to load dentists for date:",u),Oe([])}finally{es(!1)}try{const u=new URLSearchParams({date:s,with_meta:"1"});l.linkToExisting&&l.patient_id&&u.set("patient_id",l.patient_id);const D=await w.get(`/api/appointment/available-services?${u.toString()}`),X=Array.isArray((t=D.data)==null?void 0:t.services)?D.data.services:Array.isArray(D.data)?D.data:((d=D.data)==null?void 0:d.data)||[];V(Je(X));const ce=((m=D.data)==null?void 0:m.metadata)??null;if(ce){const oe=us(ce.highlight_dates??[]),ze=ce.preferred_dentist_present??oe.includes(s);Ee(ce.preferred_dentist??null),Ve({dates:oe,present:ce.preferred_dentist_present??ze}),z(Ls=>({...Ls,honor_preferred_dentist:ze}))}else Ee(null),Ve({dates:[],present:!1}),z(oe=>({...oe,honor_preferred_dentist:!1}))}catch(u){console.error("Failed to load services for new date:",u),V([]),Ee(null),Ve({dates:[],present:!1}),z(D=>({...D,honor_preferred_dentist:!1}))}}else Oe([]),V([]),Ee(null),Ve({dates:[],present:!1}),z(u=>({...u,honor_preferred_dentist:!1}))},As=async s=>{const t=R.find(d=>d.id==s);qe(t?Ge(t):null),z(d=>({...d,service_id:s,start_time:"",teeth_count:""})),ve([]),we(null),s&&l.date&&t&&!t.per_teeth_service&&await Ye(l.date,s,l.teeth_count)},as=async s=>{z(t=>({...t,teeth_count:s,start_time:""})),ve([]),we(null),l.date&&l.service_id&&s&&s>0&&await Ye(l.date,l.service_id,s)},Fs=async s=>{z(t=>({...t,honor_preferred_dentist:s,start_time:""})),ve([]),we(null),l.date&&l.service_id&&await Ye(l.date,l.service_id,l.teeth_count||null,s)},Ye=async(s,t,d=null,m=l.honor_preferred_dentist)=>{Ke(!0);try{const u={date:s,service_id:t};d&&(u.teeth_count=d),u.honor_preferred_dentist=m?1:0,l.linkToExisting&&l.patient_id&&(u.patient_id=l.patient_id);const D=await w.get("/api/appointment/available-slots",{params:u});ve(D.data.slots||D.data),we(D.data.metadata??null)}catch(u){console.error("Failed to fetch available slots:",u),ve([]),we(null)}finally{Ke(!1)}},is=s=>{if(!s)return null;const t=new Date(s),d=new Date,m=new Date;return m.setFullYear(d.getFullYear()-4),t>d?"Birthdate cannot be in the future.":t>m?"Patient must be at least 4 years old.":null},ls=()=>{const s=new Date;return s.setFullYear(s.getFullYear()-4),s.toISOString().split("T")[0]},Ds=async()=>{var t,d;if(!l.service_id||!l.date||!l.start_time){k.error("Please select service, date, and time.");return}if(Q&&Q.per_teeth_service&&!l.teeth_count){k.error("Please enter the number of teeth for this per-teeth service.");return}const s=is(l.birthdate);if(s){k.error(s);return}if(!l.linkToExisting&&(!l.first_name||!l.last_name||!l.contact_number)){k.error("Please fill in patient details including contact number (required for SMS reminders) or link to existing patient.");return}if(l.linkToExisting&&!l.patient_id){k.error("Please select an existing patient.");return}Ze(!0);try{const m={service_id:l.service_id,date:l.date,start_time:l.start_time,payment_method:l.payment_method,honor_preferred_dentist:l.honor_preferred_dentist};l.linkToExisting?m.patient_id=l.patient_id:(m.first_name=l.first_name,m.last_name=l.last_name,m.contact_number=l.contact_number,l.email&&(m.email=l.email),l.birthdate&&(m.birthdate=l.birthdate)),l.payment_method==="hmo"&&l.patient_hmo_id&&(m.patient_hmo_id=l.patient_hmo_id),l.teeth_count&&(m.teeth_count=parseInt(l.teeth_count));const u=await w.post("/api/appointments/staff-create",m);k.success(`Appointment created successfully!
Reference Code: ${u.data.appointment.reference_code}`),He(!1)}catch(m){const u=((d=(t=m.response)==null?void 0:t.data)==null?void 0:d.message)||"Failed to create appointment.";k.error(u)}finally{Ze(!1)}},Ts=!!(j.patient_id&&j.last_name.trim()&&j.contact.trim()&&j.service_id),Ms=!!(x.first_name.trim()&&x.last_name.trim()&&x.contact.trim()&&j.service_id),Is=J==="existing"?!Ts:!Ms,ns=Math.max(560,ps-zs);return e.jsxs("div",{className:"h-100 d-flex flex-column",style:{minHeight:`${ns}px`,maxHeight:`${ns}px`,overflowY:"auto",paddingRight:"0.5rem"},children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("h3",{children:"📝 Patient Visit Tracker"}),e.jsxs("button",{className:"btn btn-outline-primary",onClick:()=>Ue(!0),children:[e.jsx("i",{className:"bi bi-calendar-check me-2"}),"View Today's Schedule"]})]}),e.jsxs("div",{className:"card p-3 mb-4",children:[e.jsx("label",{children:"Visit Type"}),e.jsxs("select",{className:"form-select mb-2",value:I,onChange:s=>{G(s.target.value),L(null),q(""),f("")},children:[e.jsx("option",{value:"walkin",children:"Walk-in"}),e.jsx("option",{value:"appointment",children:"Appointment"})]}),I==="appointment"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"input-group mb-2",children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Enter Appointment Reference Code",value:U,ref:n,onChange:s=>q(s.target.value.toUpperCase())}),e.jsx("button",{className:"btn btn-outline-primary",onClick:vs,disabled:E||!U,children:E?"Searching...":"Search"})]}),_&&e.jsx("div",{className:"text-danger",children:_}),P&&e.jsxs("div",{className:"alert alert-success",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:P.patient_name})," —"," ",P.service_name," @ ",P.date," /"," ",P.time_slot]}),P.last_visit&&e.jsxs("div",{className:"mt-2 p-2 bg-light rounded",children:[e.jsx("small",{className:"text-muted",children:"📋 Last Visit:"}),e.jsxs("div",{className:"small",children:[e.jsx("strong",{children:"Date:"})," ",new Date(P.last_visit.visit_date).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})," |"," ",e.jsx("strong",{children:"Service:"})," ",P.last_visit.service_name||"N/A",P.last_visit.teeth_treated&&e.jsxs(e.Fragment,{children:[" | ",e.jsx("strong",{children:"Teeth Treated:"})," ",P.last_visit.teeth_treated]})]})]}),!P.last_visit&&e.jsx("div",{className:"mt-2 p-2 bg-light rounded",children:e.jsx("small",{className:"text-muted",children:"📋 No previous visits found"})})]})]}),e.jsxs("div",{className:"d-flex gap-2 mt-2",children:[e.jsx("button",{className:"btn btn-primary",onClick:bs,disabled:W,children:W?"Saving...":"Start Visit"}),e.jsx("button",{className:"btn btn-success",onClick:Cs,children:"📅 Make Appointment"})]})]}),e.jsxs("div",{className:"flex-grow-1 d-flex flex-column",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:["Ongoing Visits (",y.filter(s=>s.status==="pending").length," pending)"]}),A&&e.jsxs("div",{className:"d-flex align-items-center text-muted ms-3",children:[e.jsx("div",{className:"spinner-border spinner-border-sm me-2",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("small",{children:"Loading visits..."})]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:fe,children:"🔄 Refresh"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>ge(s=>!s),children:ae?"🔽 Hide Completed/Rejected":"🔼 Show All Today's Visits"})]})]}),e.jsx("div",{className:"table-responsive flex-grow-1",children:e.jsxs("table",{className:"table table-bordered table-hover mb-0",children:[e.jsx("thead",{className:"table-light sticky-top",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Contact"}),e.jsx("th",{children:"Visit Code"}),e.jsx("th",{children:"Service"}),e.jsx("th",{children:"Note"}),e.jsx("th",{children:"Started At"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Medical History"}),e.jsx("th",{style:{minWidth:"200px"},children:"Actions"})]})}),e.jsx("tbody",{children:(()=>{const s=y.filter(t=>ae||t.status==="pending");return console.log("All visits:",y),console.log("Show all visits:",ae),console.log("Filtered visits:",s),s})().map(s=>{var u,D,X,ce,oe;const t=!!s.service_id&&!!s.visit_code_sent_at,d=((u=s.assigned_dentist)==null?void 0:u.dentist_name)||((D=s.assigned_dentist)==null?void 0:D.dentist_code)||null,m=s.visit_code_sent_at?new Date(s.visit_code_sent_at).toLocaleString("en-PH",{dateStyle:"medium",timeStyle:"short"}):null;return console.log("Rendering visit:",s.id,"Patient:",s.patient),e.jsxs("tr",{children:[e.jsxs("td",{children:[(X=s.patient)==null?void 0:X.first_name," ",(ce=s.patient)==null?void 0:ce.last_name]}),e.jsx("td",{children:((oe=s.patient)==null?void 0:oe.contact_number)||"—"}),e.jsx("td",{children:s.visit_code?e.jsx("span",{className:"badge bg-primary",children:s.visit_code}):"—"}),e.jsx("td",{children:s.service?e.jsx("span",{className:"badge bg-info",children:s.service.name}):e.jsxs("span",{className:"badge bg-warning",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-1"}),"No Service"]})}),e.jsx("td",{children:s.status==="completed"&&s.visit_notes?e.jsx("button",{className:"btn btn-sm btn-outline-info",onClick:()=>ie(s),children:"🔒 View Notes"}):"—"}),e.jsx("td",{children:s.start_time?new Date(s.start_time).toLocaleString("en-PH",{dateStyle:"medium",timeStyle:"short"}):"—"}),e.jsx("td",{children:s.status}),e.jsx("td",{children:s.medical_history_status==="completed"?e.jsxs("span",{className:"badge bg-success",children:[e.jsx("i",{className:"bi bi-check-circle me-1"}),"Completed"]}):e.jsxs("span",{className:"badge bg-warning text-dark",children:[e.jsx("i",{className:"bi bi-clock me-1"}),"Pending"]})}),e.jsxs("td",{children:[s.status==="pending"&&e.jsxs("div",{className:"d-flex gap-1 flex-wrap",children:[e.jsx("button",{className:"btn btn-warning btn-sm",onClick:()=>ys(s),children:"Edit"}),e.jsxs("button",{className:`btn btn-sm ${s.medical_history_status==="completed"?"btn-success":"btn-info"}`,onClick:()=>Ss(s),title:s.medical_history_status==="completed"?"View/Edit Medical History":"Complete Medical History",children:[e.jsx("i",{className:`bi ${s.medical_history_status==="completed"?"bi-check-circle":"bi-file-medical"} me-1`}),"Medical History"]}),s.visit_code?e.jsxs("button",{className:"btn btn-primary btn-sm",onClick:()=>Me(s),disabled:s.medical_history_status==="pending",title:s.medical_history_status==="pending"?"Complete medical history first":"Send visit code to dentist",children:[e.jsx("i",{className:"bi bi-send me-1"}),"Send Visit Code to Dentist"]}):e.jsxs("span",{className:"badge bg-warning text-dark",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-1"}),"Medical History Required"]}),e.jsx("div",{className:"small text-muted w-100",children:d?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-person-badge me-1"}),"Assigned dentist: ",d,m&&e.jsxs("div",{children:[e.jsx("i",{className:"bi bi-clock-history me-1"}),"Sent: ",m]})]}):e.jsxs("span",{children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Visit code not yet sent"]})}),e.jsx("button",{className:`btn btn-sm ${t?"btn-success":"btn-outline-secondary"}`,onClick:()=>gs(s.id),disabled:!t,title:s.service_id?s.visit_code_sent_at?"Complete this visit":"Send the visit code before completing this visit":"Please select a service first",children:s.service_id?"Finish":e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-1"}),"Finish"]})}),e.jsx("button",{className:"btn btn-danger btn-sm",onClick:()=>{T(s.id),H(""),ue(!1),i(!0)},children:"Reject"})]}),s.status==="completed"&&e.jsx("div",{className:"d-flex gap-1 flex-wrap",children:e.jsx("button",{className:"btn btn-success btn-sm",onClick:()=>Ns(s.id),disabled:Fe===s.id,title:"Send Receipt Email",children:Fe===s.id?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-envelope me-1"}),"Send Receipt"]})})})]})]},s.id)})})]})})]}),le&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:M==="inquiry_only"?"Mark as Inquiry":"Reject Visit"}),e.jsx("button",{className:"btn-close",onClick:()=>i(!1)})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("label",{className:"form-label",children:M==="inquiry_only"?"Reason for inquiry:":"Reason for rejection:"}),e.jsxs("select",{className:"form-select",value:M,onChange:s=>H(s.target.value),children:[e.jsx("option",{value:"",children:"Select reason"}),e.jsx("option",{value:"human_error",children:"Human Error"}),e.jsx("option",{value:"left",children:"Patient Left"}),e.jsx("option",{value:"line_too_long",children:"Line Too Long"}),e.jsx("option",{value:"inquiry_only",children:"Inquiry Only"})]}),M==="line_too_long"&&e.jsxs("div",{className:"form-check mt-2",children:[e.jsx("input",{type:"checkbox",className:"form-check-input",checked:$,onChange:s=>ue(s.target.checked),id:"offerAppt"}),e.jsx("label",{htmlFor:"offerAppt",className:"form-check-label",children:"Patient was offered an appointment"})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>i(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-danger",disabled:!M,onClick:async()=>{await w.post(`/api/visits/${F}/reject`,{reason:M,offered_appointment:$}),i(!1),T(null),await fe()},children:M==="inquiry_only"?"Mark as Inquiry":"Confirm Reject"})]})]})})}),B&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Edit Patient Info"}),e.jsx("button",{className:"btn-close",onClick:()=>te(null)})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("ul",{className:"nav nav-tabs mb-3",children:[e.jsx("li",{className:"nav-item",children:e.jsx("button",{type:"button",className:`nav-link ${J==="existing"?"active":""}`,onClick:()=>{ne("existing"),ee([]),de(j.last_name||"")},children:"Existing Patient"})}),e.jsx("li",{className:"nav-item",children:e.jsx("button",{type:"button",className:`nav-link ${J==="new"?"active":""}`,onClick:()=>{ne("new"),ee([])},children:"New Patient"})})]}),J==="existing"&&e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"form-label",children:"Patient ID"}),e.jsx("input",{className:"form-control mb-2",value:j.patient_id||"",readOnly:!0,placeholder:"Select a patient"}),e.jsx("label",{className:"form-label",children:"Patient Surname"}),e.jsxs("div",{className:"position-relative mb-2",children:[e.jsx("input",{className:"form-control",value:Ne,onChange:s=>{const t=s.target.value;de(t),xe(d=>{const m={...d,last_name:t};return t||(m.patient_id="",m.first_name=""),m}),t||g(null)},placeholder:"Search by surname (min 2 characters)"}),ke&&e.jsx("span",{className:"spinner-border spinner-border-sm text-secondary position-absolute top-50 end-0 translate-middle-y me-2"}),Se.length>0&&e.jsx("div",{className:"list-group position-absolute w-100 shadow-sm",style:{zIndex:10,maxHeight:"220px",overflowY:"auto"},children:Se.map(s=>e.jsxs("button",{type:"button",className:`list-group-item list-group-item-action ${(c==null?void 0:c.id)===s.id?"active":""}`,onClick:()=>_s(s),children:[e.jsxs("div",{className:"fw-semibold",children:[s.last_name,", ",s.first_name]}),e.jsxs("div",{className:"small text-muted",children:["ID: ",s.id," • ",s.contact_number||"No contact"]})]},s.id))})]}),e.jsx("div",{className:"form-text mb-3",children:'Start typing at least 2 letters to search by surname. Results appear as "surname, firstname".'}),e.jsx("label",{className:"form-label",children:"Contact Number"}),e.jsx("input",{className:"form-control mb-3",value:j.contact,onChange:s=>xe(t=>({...t,contact:s.target.value})),placeholder:"Enter contact number"})]}),J==="new"&&e.jsxs(e.Fragment,{children:[e.jsx("label",{className:"form-label",children:"First Name *"}),e.jsx("input",{className:"form-control mb-2",value:x.first_name,onChange:s=>N(t=>({...t,first_name:s.target.value}))}),e.jsx("label",{className:"form-label",children:"Last Name *"}),e.jsx("input",{className:"form-control mb-2",value:x.last_name,onChange:s=>N(t=>({...t,last_name:s.target.value}))}),e.jsx("label",{className:"form-label",children:"Contact Number *"}),e.jsx("input",{className:"form-control mb-3",value:x.contact,onChange:s=>N(t=>({...t,contact:s.target.value}))})]}),e.jsx("label",{className:"form-label",children:"Service"}),e.jsxs("select",{className:"form-select",value:j.service_id,onChange:s=>xe(t=>({...t,service_id:s.target.value})),children:[e.jsx("option",{value:"",children:"— Select —"}),R.map(s=>e.jsxs("option",{value:s.id,children:[s.name," –"," ",s.type==="promo"?`₱${Number(s.promo_price).toLocaleString()} (${s.discount_percent}% off)`:s.type==="special"?`₱${Number(s.price).toLocaleString()} Special Service`:`₱${Number(s.price).toLocaleString()}`]},s.id))]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>te(null),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:ws,disabled:Is,children:"Save"})]})]})})}),S&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header bg-warning",children:[e.jsx("h5",{className:"modal-title",children:"⚠️ Potential Duplicate Patient Found"}),e.jsx("button",{className:"btn-close",onClick:()=>{O(!1),te(null)}})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"alert alert-warning",children:[e.jsx("strong",{children:"Warning:"})," We found existing patient(s) with the same name. This might be a duplicate entry. Please review and link if this is the same patient."]}),e.jsx("h6",{children:"Matching Patients:"}),v.map(s=>e.jsx("div",{className:"card mb-2 p-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsxs("strong",{children:[s.first_name," ",s.last_name]}),e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["Contact: ",s.contact_number||"N/A",e.jsx("br",{}),"Birthdate: ",s.birthdate?new Date(s.birthdate).toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"}):"N/A",e.jsx("br",{}),s.has_user_account&&e.jsxs("span",{className:"badge bg-success",children:["Has Online Account (",s.user_email,")"]})]})]}),e.jsx("button",{className:"btn btn-primary",onClick:async()=>{if(window.confirm(`Link this visit to ${s.first_name} ${s.last_name}?`))try{const t={target_patient_id:s.id};j.service_id&&(t.service_id=j.service_id),await w.post(`/api/visits/${B.id}/link-existing`,t),O(!1),te(null),await fe(),k.success("Visit successfully linked to existing patient!")}catch{k.error("Failed to link visit to patient.")}},children:"Link to This Patient"})]})},s.id)),e.jsx("hr",{}),e.jsx("p",{className:"text-muted",children:e.jsx("small",{children:"If none of these patients match, you can close this dialog and the walk-in patient record will remain separate."})})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-secondary",onClick:()=>{O(!1),te(null)},children:"Keep as Separate Patient"})})]})})}),Z&&e.jsx(Vs,{visit:Z,onClose:()=>je(null),onComplete:js}),Ce&&e.jsx(Hs,{visit:Ce,onClose:()=>ie(null)}),Te&&e.jsx($s,{visit:Te,onClose:()=>Me(null),onSuccess:async()=>{await fe()}}),ds&&We&&e.jsx(Rs,{visit:We,onClose:()=>{$e(!1),Re(null)},onSuccess:ks}),os&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"📅 Create Appointment for Walk-in Patient"}),e.jsx("button",{className:"btn-close",onClick:()=>He(!1)})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("h6",{children:"Patient Information"}),e.jsxs("div",{className:"form-check mb-3",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"linkToExisting",checked:l.linkToExisting,onChange:s=>z(t=>({...t,linkToExisting:s.target.checked,patient_id:s.target.checked?t.patient_id:"",first_name:s.target.checked?"":t.first_name,last_name:s.target.checked?"":t.last_name,contact_number:s.target.checked?"":t.contact_number,email:s.target.checked?"":t.email,birthdate:s.target.checked?"":t.birthdate}))}),e.jsx("label",{className:"form-check-label",htmlFor:"linkToExisting",children:"Link to existing patient"})]}),l.linkToExisting?e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Search Existing Patient"}),e.jsx("input",{className:"form-control",placeholder:"Search by name or contact (min 2 characters)",value:he,onChange:async s=>{const t=s.target.value;if(be(t),pe([]),K(null),t.length>=2)try{const d=await w.get("/api/patients/search",{params:{q:t.trim()}});pe(d.data)}catch{k.error("Search failed.")}}}),re.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("small",{className:"text-muted",children:"Select a patient:"}),re.map(s=>e.jsx("div",{className:"card p-2 mb-1 cursor-pointer",onClick:()=>{z(t=>({...t,patient_id:s.id})),K(s)},style:{cursor:"pointer",backgroundColor:l.patient_id===s.id?"#e3f2fd":"white"},children:e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{children:[e.jsxs("strong",{children:[s.first_name," ",s.last_name]}),e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["Contact: ",s.contact_number||"N/A"," | Birthdate: ",s.birthdate?new Date(s.birthdate).toLocaleDateString():"N/A"]})]}),l.patient_id===s.id&&e.jsx("span",{className:"badge bg-primary",children:"Selected"})]})},s.id))]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentFirstName",children:"First Name *"}),e.jsx("input",{className:"form-control",value:l.first_name,onChange:s=>z(t=>({...t,first_name:s.target.value})),id:"staffAppointmentFirstName"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentLastName",children:"Last Name *"}),e.jsx("input",{className:"form-control",value:l.last_name,onChange:s=>z(t=>({...t,last_name:s.target.value})),id:"staffAppointmentLastName"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentContact",children:"Contact Number *"}),e.jsx("input",{className:"form-control",value:l.contact_number,onChange:s=>z(t=>({...t,contact_number:s.target.value})),placeholder:"Required for SMS reminders",id:"staffAppointmentContact"}),e.jsxs("div",{className:"form-text",children:[e.jsx("i",{className:"bi bi-phone me-1"}),"Required for SMS appointment reminders"]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Email (Optional)"}),e.jsx("input",{type:"email",className:"form-control",value:l.email,onChange:s=>z(t=>({...t,email:s.target.value}))})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Birthdate (Optional)"}),e.jsx("input",{type:"date",className:"form-control",value:l.birthdate,onChange:s=>{const t=s.target.value;z(m=>({...m,birthdate:t}));const d=is(t);d&&k.error(d)},max:ls()}),e.jsxs("div",{className:"form-text",children:["Must be at least 4 years old (dates after ",ls()," are not selectable)."]})]})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("h6",{children:"Appointment Details"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentDate",children:"Date *"}),e.jsx("input",{type:"date",className:"form-control",value:l.date,onChange:s=>Ps(s.target.value),min:new Date().toISOString().slice(0,10),max:new Date(Date.now()+7*24*60*60*1e3).toISOString().slice(0,10),placeholder:"Select a date",id:"staffAppointmentDate"}),e.jsxs("div",{className:"form-text",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),l.date?"You can only select dates up to 7 days from today":"Please select a date first to see available dentists and services"]}),ye&&e.jsxs("div",{className:"alert alert-info border-0 shadow-sm mt-3",children:[e.jsx("strong",{children:"Recent dentist:"})," ",ye.name||ye.code,e.jsx("div",{className:"small mt-2",children:Array.isArray(Pe.dates)&&Pe.dates.length>0?e.jsxs(e.Fragment,{children:["Available on:"," ",e.jsx("span",{className:"fw-semibold",children:Pe.dates.join(", ")})]}):"No upcoming availability recorded."}),l.date&&!Be&&e.jsx("div",{className:"small text-muted mt-2",children:"Your dentist is not scheduled on this selected date."})]})]}),e.jsxs("div",{className:"form-check form-switch mb-3",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"staffHonorPreferredDentistSwitch",checked:l.honor_preferred_dentist,onChange:s=>Fs(s.target.checked),disabled:!ye||!Be}),e.jsx("label",{className:"form-check-label",htmlFor:"staffHonorPreferredDentistSwitch",children:"Prefer assigning to recent dentist"}),!ye&&e.jsx("div",{className:"form-text",children:"No recent dentist found for this patient yet; any dentist can be assigned."}),ye&&l.date&&!Be&&e.jsx("div",{className:"form-text text-muted",children:"Dentist not available on this date."})]}),l.date&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Available Dentists"}),xs?e.jsxs("div",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-hourglass-split me-1"}),"Loading available dentists..."]}):Le.length>0?e.jsxs("div",{className:"alert alert-info border-0 shadow-sm",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("div",{children:[e.jsx("i",{className:"bi bi-person-check me-2"}),e.jsxs("strong",{children:[Le.length," dentist",Le.length!==1?"s":""," available"]})]}),e.jsx("span",{className:"badge bg-primary",children:Le.length})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("small",{className:"text-muted",children:"Available dentists:"}),e.jsx("div",{className:"mt-1",children:Le.map((s,t)=>e.jsxs("span",{className:"badge bg-light text-dark me-1 mb-1",children:[s.dentist_name," (",s.dentist_code,")"]},t))})]})]}):e.jsxs("div",{className:"alert alert-warning border-0 shadow-sm",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"No dentists available on this date"]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentService",children:"Service *"}),e.jsxs("select",{className:"form-select",value:l.service_id,onChange:s=>As(s.target.value),disabled:!l.date,id:"staffAppointmentService",children:[e.jsx("option",{value:"",children:l.date?"Select a service":"Please select a date first"}),R.map(s=>e.jsxs("option",{value:s.id,children:[s.name," –"," ",s.type==="promo"?`₱${Number(s.promo_price).toLocaleString()} (${s.discount_percent}% off)`:s.type==="special"?`₱${Number(s.price).toLocaleString()} Special Service`:`₱${Number(s.price).toLocaleString()}`,s.per_teeth_service?" per tooth":""]},s.id))]}),!l.date&&e.jsxs("div",{className:"form-text text-muted",children:[e.jsx("i",{className:"bi bi-lock me-1"}),"Please select a date first to enable service selection"]})]}),Q&&e.jsx("div",{className:"alert alert-info border-0 shadow-sm mb-4",role:"alert",children:e.jsx("div",{className:"d-flex align-items-center justify-content-between flex-wrap",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("i",{className:"bi bi-check-circle me-3 fs-4"}),e.jsxs("div",{children:[e.jsx("strong",{children:"Service Selected:"}),e.jsx("br",{}),e.jsx("span",{className:"fs-5",children:Q.name}),e.jsx("br",{}),e.jsxs("span",{className:"text-info fw-semibold",children:["₱",Number(Q.price||Q.promo_price).toLocaleString(),Q.per_teeth_service?" per tooth":""]}),Q.per_teeth_service&&e.jsx("div",{className:"mt-2",children:e.jsxs("small",{className:"text-info",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Total cost depends on number of teeth treated"]})})]})]})})}),Q&&Q.per_teeth_service&&e.jsx("div",{className:"alert alert-warning border-0 shadow-sm mb-4",role:"alert",children:e.jsxs("div",{className:"d-flex align-items-start",children:[e.jsx("i",{className:"bi bi-lightbulb me-3 fs-4 text-warning"}),e.jsxs("div",{children:[e.jsxs("h6",{className:"alert-heading text-warning mb-2",children:[e.jsx("i",{className:"bi bi-tooth me-2"}),"Per-Teeth Service Information"]}),e.jsx("p",{className:"mb-2",children:"For per-teeth services, please enter the number of teeth that need treatment. This will determine:"}),e.jsxs("ul",{className:"mb-2 ps-3",children:[e.jsx("li",{children:"Appointment duration"}),e.jsx("li",{children:"Available time slots"}),e.jsx("li",{children:"Accurate cost calculation"})]})]})]})}),Q&&Q.per_teeth_service&&e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-label",children:["Number of Teeth to be Treated *",e.jsx("span",{className:"text-muted ms-1",children:"(Required for per-teeth services)"})]}),e.jsxs("div",{className:"position-relative",children:[e.jsx("input",{type:"number",min:"1",max:"32",className:"form-control",value:l.teeth_count,onChange:s=>{const t=s.target.value;(t===""||parseInt(t)>=1&&parseInt(t)<=32)&&as(t)},placeholder:"Select or enter number of teeth",style:{paddingRight:"60px"}}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2",onClick:()=>{const s=document.getElementById("teethCountModal");s&&(new bootstrap.Modal(s).show(),setTimeout(()=>{const d=s.querySelector(".teeth-roulette"),m=s.querySelector(`[data-teeth="${l.teeth_count}"]`);if(d&&m&&l.teeth_count){const u=m.offsetTop,D=d.clientHeight,X=m.clientHeight;d.scrollTop=u-D/2+X/2}},300))},style:{height:"32px",width:"40px",padding:"0"},children:e.jsx("i",{className:"bi bi-chevron-down"})})]}),e.jsx("div",{className:"modal fade",id:"teethCountModal",tabIndex:"-1","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-tooth me-2"}),"Select Number of Teeth"]}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body p-0",children:e.jsx("div",{className:"teeth-roulette",style:{height:"200px",overflowY:"auto",padding:"10px",scrollBehavior:"smooth",touchAction:"pan-y",WebkitOverflowScrolling:"touch"},onScroll:s=>{s.target.scrollTop=Math.round(s.target.scrollTop/50)*50},onTouchStart:s=>{s.target.style.backgroundColor="#f8f9fa"},onTouchEnd:s=>{setTimeout(()=>{s.target.style.backgroundColor="transparent"},150)},children:Array.from({length:32},(s,t)=>t+1).map(s=>e.jsx("div",{"data-teeth":s,className:`teeth-option d-flex align-items-center justify-content-center p-3 border-bottom cursor-pointer ${l.teeth_count==s?"bg-primary text-white":"bg-light"}`,onClick:()=>{as(s.toString());const t=document.getElementById("teethCountModal");t&&bootstrap.Modal.getInstance(t).hide()},style:{minHeight:"50px",cursor:"pointer",transition:"all 0.2s ease",userSelect:"none"},onMouseEnter:t=>{l.teeth_count!=s&&(t.target.style.backgroundColor="#e9ecef")},onMouseLeave:t=>{l.teeth_count!=s&&(t.target.style.backgroundColor="#f8f9fa")},children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"fs-4 fw-bold",children:s}),e.jsx("div",{className:"small",children:s===1?"tooth":"teeth"}),l.teeth_count==s&&e.jsx("div",{className:"small",children:e.jsx("i",{className:"bi bi-check-circle-fill"})})]})},s))})}),e.jsx("div",{className:"modal-footer",children:e.jsx("div",{className:"w-100 text-center",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Swipe to scroll • Tap to select • Max 32 teeth"]})})})]})})}),e.jsxs("div",{className:"form-text",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Enter the number of teeth that need treatment. Time slots will be calculated based on this.",l.teeth_count&&e.jsxs("div",{className:"mt-1",children:[e.jsx("strong",{children:"Estimated cost:"})," ₱",Number(Q.price||Q.promo_price)*parseInt(l.teeth_count||0).toLocaleString()]})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentTimeSlot",children:"Time Slot *"}),hs?e.jsx("div",{className:"text-muted",children:"Loading available slots..."}):Qe.length>0?e.jsxs(e.Fragment,{children:[(_e==null?void 0:_e.preferred_dentist)&&e.jsxs("div",{className:"alert alert-info border-0 shadow-sm mb-2",children:[e.jsx("i",{className:"bi bi-person-badge me-2"}),l.honor_preferred_dentist?"Scheduling with:":"Suggested dentist:"," ",_e.preferred_dentist.name||_e.preferred_dentist.code]}),_e&&_e.effective_honor_preferred_dentist===!1&&l.honor_preferred_dentist&&e.jsxs("div",{className:"alert alert-warning border-0 shadow-sm mb-2",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"Preferred dentist is unavailable for the selected slot. Another dentist will be assigned."]}),e.jsxs("select",{className:"form-select",value:l.start_time,onChange:s=>z(t=>({...t,start_time:s.target.value})),id:"staffAppointmentTimeSlot",children:[e.jsx("option",{value:"",children:"Select time slot"}),Qe.map(s=>e.jsx("option",{value:s,children:s},s))]})]}):l.service_id&&l.date?e.jsx("div",{className:"text-muted",children:Q&&Q.per_teeth_service&&!l.teeth_count?"Please enter number of teeth first to see available time slots.":"No available slots for this service on this date."}):e.jsx("div",{className:"text-muted",children:l.date?l.service_id?"Please select service and date first.":"Please select a service first.":"Please select a date first."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Payment Method *"}),e.jsxs("select",{className:"form-select",value:l.payment_method,onChange:s=>z(t=>({...t,payment_method:s.target.value})),disabled:!l.date||!l.service_id,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"maya",children:"Maya Payment"}),e.jsx("option",{value:"hmo",children:"HMO"})]}),(!l.date||!l.service_id)&&e.jsxs("div",{className:"form-text text-muted",children:[e.jsx("i",{className:"bi bi-lock me-1"}),"Please select date and service first to enable payment method selection"]})]}),l.payment_method==="hmo"&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"HMO (Optional)"}),e.jsx("select",{className:"form-select",value:l.patient_hmo_id,onChange:s=>z(t=>({...t,patient_hmo_id:s.target.value})),children:e.jsx("option",{value:"",children:"No HMO selected"})})]})]})]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>He(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:Ds,disabled:Xe,children:Xe?"Creating...":"Create Appointment"})]})]})})}),e.jsx(Os,{show:ms,onClose:()=>Ue(!1)})]})}export{Zs as default};
