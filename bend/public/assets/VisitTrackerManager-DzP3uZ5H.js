import{r as i,j as e,z as _}from"./react-vendor-D3yaKSZ_.js";import{a as S}from"./index-D6CnA4iT.js";import"./chart-vendor-BsnJAHr2.js";import"./bootstrap-vendor-CM53U_Of.js";import"./vendor-axios-ngrFHoWO.js";import"./pdf-vendor-BZobkf7J.js";import"./vendor-utils-DLELI0UM.js";import"./excel-vendor-6kUf8nhb.js";function hs({visit:r,onClose:C,onComplete:D}){var Me,pe,Se,be,De;const[c,P]=i.useState(1),[q,H]=i.useState([]),[m,F]=i.useState([]),[Q,T]=i.useState(!1),[B,z]=i.useState(!1),[E,I]=i.useState([]),[X,j]=i.useState(""),[b,J]=i.useState(""),[l,N]=i.useState(""),[A,V]=i.useState(""),[$,w]=i.useState(null),[U,k]=i.useState(!1),[le,ee]=i.useState(null),[de,ye]=i.useState(!1),[Z,_e]=i.useState("paid"),[me,he]=i.useState(""),[se,ie]=i.useState("");i.useEffect(()=>{ne(),d()},[]);const ne=async()=>{try{const n=await S.get("/api/inventory/items");H(n.data.data||[])}catch(n){console.error("Failed to load inventory items",n)}},d=async()=>{var n,t;try{const f=(await S.get(`/api/visits/${r.id}/dentist-notes`)).data;f.dentist_notes&&j(f.dentist_notes),f.findings&&J(f.findings),f.treatment_plan&&N(f.treatment_plan),f.teeth_treated&&V(f.teeth_treated),(f.created_by||f.created_at)&&w({created_by:f.created_by,created_at:f.created_at,updated_by:f.updated_by,updated_at:f.updated_at})}catch(o){console.log("No dentist notes found or error fetching notes:",(t=(n=o==null?void 0:o.response)==null?void 0:n.data)==null?void 0:t.message)}},g=()=>{F([...m,{item_id:"",quantity:"",notes:""}])},v=(n,t,o)=>{const f=[...m];f[n][t]=o,F(f)},p=n=>{F(m.filter((t,o)=>o!==n))},y=(n,t)=>{const o=E.some(f=>f.item_id===n);I(o?E.filter(f=>f.item_id!==n):[...E,{item_id:n,quantity:1,unit_price:Number(t.patient_price)||0}])},R=(n,t)=>{I(E.map(o=>o.item_id===n?{...o,quantity:Math.max(1,Number(t)||1)}:o))},O=async()=>{const n=m.filter(o=>o.item_id&&o.quantity),t={stock_items:n,billable_items:E.map(o=>({item_id:o.item_id,quantity:Number(o.quantity)||1,unit_price:Number(o.unit_price)||0})),dentist_notes:X,findings:b,treatment_plan:l,teeth_treated:A,payment_status:L?"paid":Z,onsite_payment_amount:L?null:me?Number(me):null,payment_method_change:L?null:se||null};if(n.length===0&&!de){ee(t),k(!0);return}await G(t)},G=async n=>{var t,o;z(!0);try{await S.post(`/api/visits/${r.id}/complete-with-details`,n);try{const f=await S.post(`/api/receipts/visit/${r.id}/email`,{},{skip401Handler:!0});f.data.note?_.success(`Visit completed successfully!

${f.data.message}

${f.data.note}`):_.success(`Visit completed successfully!

Receipt sent to: ${f.data.email}`)}catch(f){console.error("Failed to send receipt email:",f),_.success(`Visit completed successfully!

Note: Receipt email could not be sent. Patient can download receipt from their appointments page.`)}D(),C()}catch(f){_.error(((o=(t=f==null?void 0:f.response)==null?void 0:t.data)==null?void 0:o.message)||"Failed to complete visit")}finally{ee(null),ye(!1),z(!1)}},re=((Me=r.payments)==null?void 0:Me.reduce((n,t)=>n+(Number(t.amount_paid)||0),0))||0,te=Number((pe=r.service)==null?void 0:pe.price)||0,ue=!!((Se=r.service)!=null&&Se.per_teeth_service),ce=E.reduce((n,t)=>{const o=Number(t.unit_price)||0,f=Number(t.quantity)||1;return n+o*f},0),K=te+ce,W=K-re,we=(be=r.payments)==null?void 0:be.find(n=>n.method==="maya"&&n.status==="paid"),L=!!we;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"modal fade show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1050,overflowY:"auto",display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem"},tabIndex:"-1",role:"dialog",children:e.jsx("div",{className:"modal-dialog modal-lg",role:"document",style:{maxWidth:"800px",maxHeight:"calc(100vh - 2rem)",margin:"0 auto",width:"100%"},children:e.jsxs("div",{className:"modal-content d-flex flex-column",style:{maxHeight:"calc(100vh - 2rem)",overflow:"hidden"},children:[e.jsxs("div",{className:"modal-header bg-primary text-white py-2 flex-shrink-0",style:{position:"sticky",top:0,zIndex:1,borderBottom:"1px solid #dee2e6"},children:[e.jsxs("h5",{className:"modal-title fw-bold mb-0",children:[e.jsx("i",{className:"fas fa-check-circle me-2"}),"Complete Visit"]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:C,"aria-label":"Close",style:{fontSize:"1.2rem"}})]}),e.jsxs("div",{className:"modal-body p-3 flex-grow-1",style:{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:0},children:[e.jsx("div",{className:"d-flex justify-content-center mb-3",children:e.jsx("div",{className:"progress w-100",style:{height:"4px"},children:e.jsx("div",{className:"progress-bar bg-primary",role:"progressbar",style:{width:`${c/3*100}%`},"aria-valuenow":c,"aria-valuemin":"0","aria-valuemax":"3"})})}),e.jsx("div",{className:"d-flex justify-content-between mb-3",children:[1,2,3].map(n=>e.jsxs("div",{className:"d-flex flex-column align-items-center",children:[e.jsx("div",{className:`rounded-circle d-flex align-items-center justify-content-center mb-1 ${c>=n?"bg-primary text-white shadow-sm":"bg-light text-muted border"}`,style:{width:"36px",height:"36px",fontSize:"14px"},children:e.jsx("i",{className:`fas ${n===1?"fa-boxes":n===2?"fa-sticky-note":"fa-credit-card"}`})}),e.jsxs("small",{className:`text-center ${c>=n?"text-primary fw-bold":"text-muted"}`,style:{fontSize:"12px"},children:[n===1&&"Stock",n===2&&"Notes",n===3&&"Payment"]})]},n))}),c===1&&e.jsxs("div",{className:"card border-0 shadow-sm",children:[e.jsx("div",{className:"card-header bg-gradient bg-light py-2",children:e.jsxs("h6",{className:"card-title mb-0",children:[e.jsx("i",{className:"fas fa-boxes text-primary me-2"}),"Consume Stock Items"]})}),e.jsxs("div",{className:"card-body p-3",children:[m.length>0?e.jsx("div",{className:"row g-2",children:m.map((n,t)=>e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"card border border-primary border-opacity-25",children:e.jsx("div",{className:"card-body p-2",children:e.jsxs("div",{className:"row g-2 align-items-end",children:[e.jsx("div",{className:"col-md-4",children:e.jsxs("select",{className:"form-select",value:n.item_id,onChange:o=>v(t,"item_id",o.target.value),children:[e.jsx("option",{value:"",children:"Item"}),q.map(o=>e.jsxs("option",{value:o.id,children:[o.name," (Stock: ",o.total_on_hand||0,")"]},o.id))]})}),e.jsx("div",{className:"col-md-2",children:e.jsx("input",{type:"number",step:"1",min:"0",className:"form-control",value:n.quantity,onChange:o=>v(t,"quantity",o.target.value),placeholder:"Quantity"})}),e.jsx("div",{className:"col-md-4",children:e.jsx("input",{type:"text",className:"form-control",value:n.notes,onChange:o=>v(t,"notes",o.target.value),placeholder:"Notes"})}),e.jsx("div",{className:"col-md-2",children:e.jsxs("button",{type:"button",onClick:()=>p(t),className:"btn btn-outline-danger w-100",title:"Remove item",style:{minHeight:"38px"},children:[e.jsx("i",{className:"fas fa-trash me-1"}),"Remove Item"]})})]})})})},t))}):e.jsxs("div",{className:"text-center py-4 text-muted",children:[e.jsx("i",{className:"fas fa-boxes fa-3x mb-3 text-primary opacity-50"}),e.jsx("p",{className:"mb-0",children:"No stock items added yet"}),e.jsx("small",{children:'Click "Add Item" to start consuming stock'})]}),e.jsx("div",{className:"mt-3 text-center",children:e.jsxs("button",{type:"button",onClick:g,className:"btn btn-primary",style:{minWidth:"120px"},children:[e.jsx("i",{className:"fas fa-plus me-2"}),"Add Item"]})}),e.jsx("hr",{className:"my-4"}),e.jsxs("div",{className:"alert alert-info py-2 mb-3",children:[e.jsx("i",{className:"fas fa-info-circle me-2"}),e.jsx("strong",{children:"Additional Items:"})," Select items that patients can purchase separately (not included in procedure)"]}),e.jsx("div",{className:"card border-warning",children:e.jsxs("div",{className:"card-body p-2",children:[e.jsx("div",{className:"row",children:q.filter(n=>n.is_sellable&&n.patient_price).map(n=>{var t;return e.jsxs("div",{className:"col-12 mb-2",children:[e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",checked:E.some(o=>o.item_id===n.id),onChange:()=>y(n.id,n),id:`billable-${n.id}`}),e.jsxs("label",{className:"form-check-label",htmlFor:`billable-${n.id}`,children:[n.name," - ₱",Number(n.patient_price).toLocaleString()]})]}),E.some(o=>o.item_id===n.id)&&e.jsx("div",{className:"ms-4 mt-1",children:e.jsxs("div",{className:"input-group input-group-sm",style:{width:"150px"},children:[e.jsx("span",{className:"input-group-text",children:"Qty:"}),e.jsx("input",{type:"number",className:"form-control",min:"1",value:((t=E.find(o=>o.item_id===n.id))==null?void 0:t.quantity)||1,onChange:o=>R(n.id,o.target.value)})]})})]},n.id)})}),q.filter(n=>n.is_sellable&&n.patient_price).length===0&&e.jsx("p",{className:"text-muted mb-0 small",children:"No billable items available. Configure items as sellable in inventory settings."})]})})]})]}),c===2&&e.jsxs("div",{className:"card border-0 shadow-sm",children:[e.jsx("div",{className:"card-header bg-gradient bg-light py-2",children:e.jsxs("h6",{className:"card-title mb-0",children:[e.jsx("i",{className:"fas fa-sticky-note text-primary me-2"}),"Visit Documentation"]})}),e.jsxs("div",{className:"card-body p-3",children:[$&&e.jsxs("div",{className:"alert alert-info mb-3 py-2 border-0",children:[e.jsxs("h6",{className:"alert-heading small",children:[e.jsx("i",{className:"fas fa-info-circle me-2"}),"Original Notes Information"]}),e.jsxs("p",{className:"mb-1 small",children:[e.jsx("strong",{children:"Created by:"})," ",$.created_by," on ",new Date($.created_at).toLocaleString()]}),$.updated_by&&$.updated_at&&e.jsxs("p",{className:"mb-1 small",children:[e.jsx("strong",{children:"Last updated by:"})," ",$.updated_by," on ",new Date($.updated_at).toLocaleString()]}),e.jsx("hr",{className:"my-2"}),e.jsx("p",{className:"mb-0 small",children:"You can edit these notes as needed for the final documentation."})]}),e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-user-md text-primary me-1"}),"Dentist Notes"]}),e.jsx("textarea",{className:"form-control",rows:"3",value:X,onChange:n=>j(n.target.value),placeholder:"Enter dentist's notes about the visit..."})]}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-search text-primary me-1"}),"Findings"]}),e.jsx("textarea",{className:"form-control",rows:"3",value:b,onChange:n=>J(n.target.value),placeholder:"Document any findings or observations..."})]}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-clipboard-list text-primary me-1"}),"Treatment Plan"]}),e.jsx("textarea",{className:"form-control",rows:"3",value:l,onChange:n=>N(n.target.value),placeholder:"Outline the treatment plan or follow-up instructions..."})]}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-tooth text-primary me-1"}),"Teeth Treated"]}),e.jsx("input",{type:"text",className:"form-control",value:A,onChange:n=>V(n.target.value),placeholder:"e.g., 1,2,3,4,5 or leave blank if not applicable"}),e.jsx("div",{className:"form-text",children:"Enter tooth numbers separated by commas (e.g., 1,2,3,4,5). Use the Universal Numbering System."})]})]})]})]}),c===3&&e.jsxs("div",{className:"card border-0 shadow-sm",children:[e.jsx("div",{className:"card-header bg-gradient bg-light py-2",children:e.jsxs("h6",{className:"card-title mb-0",children:[e.jsx("i",{className:"fas fa-credit-card text-primary me-2"}),"Payment Verification"]})}),e.jsx("div",{className:"card-body p-3",children:e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"card border-0 shadow-sm",style:{background:"linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)"},children:e.jsxs("div",{className:"card-body p-3",children:[e.jsxs("h6",{className:"card-title text-dark mb-3",children:[e.jsx("i",{className:"fas fa-receipt text-primary me-2"}),"Payment Summary"]}),e.jsxs("div",{className:"row g-3",children:[e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Service"}),e.jsx("div",{className:"fw-semibold text-dark",children:((De=r.service)==null?void 0:De.name)||"N/A"})]})}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Service Price"}),e.jsxs("div",{className:"fw-semibold text-primary",children:["₱",te.toLocaleString(),ue&&e.jsx("small",{className:"text-info d-block",children:"per tooth"})]})]})}),ce>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-12",children:[e.jsx("hr",{className:"my-2"}),e.jsx("div",{className:"fw-semibold mb-2",children:"Additional Items:"}),E.map(n=>{const t=q.find(o=>o.id===n.item_id);return e.jsxs("div",{className:"d-flex justify-content-between mb-1",children:[e.jsxs("small",{children:[t==null?void 0:t.name," (x",n.quantity,")"]}),e.jsxs("small",{className:"fw-semibold",children:["₱",Number(n.unit_price*n.quantity).toLocaleString()]})]},n.item_id)}),e.jsx("hr",{className:"my-2"})]}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Additional Charges"}),e.jsxs("div",{className:"fw-semibold text-warning",children:["₱",ce.toLocaleString()]})]})}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Total Price"}),e.jsxs("div",{className:"fw-bold text-primary",children:["₱",K.toLocaleString()]})]})})]}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Total Paid"}),e.jsxs("div",{className:"fw-semibold text-success",children:["₱",re.toLocaleString()]})]})}),e.jsx("div",{className:"col-6",children:e.jsxs("div",{className:"d-flex flex-column",children:[e.jsx("small",{className:"text-muted mb-1",children:"Balance"}),e.jsxs("div",{className:`fw-bold ${W>0?"text-warning":"text-success"}`,children:["₱",W.toLocaleString()]})]})})]})]})})}),L&&e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"alert alert-success border-0 shadow-sm",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("i",{className:"fas fa-check-circle fa-2x text-success me-3"}),e.jsxs("div",{children:[e.jsxs("h6",{className:"alert-heading mb-1",children:[e.jsx("i",{className:"fas fa-credit-card me-2"}),"Maya Payment Completed"]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Amount Paid:"})," ₱",Number(we.amount_paid||0).toLocaleString()]}),e.jsxs("p",{className:"mb-0",children:[e.jsx("strong",{children:"Payment Date:"})," ",new Date(we.paid_at).toLocaleString()]}),e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"fas fa-lock me-1"}),"Payment information is read-only as the Maya payment has been successfully completed."]})]})]})})}),ce>0&&!L&&e.jsx("div",{className:"col-12",children:e.jsx("div",{className:"alert alert-warning border-0 shadow-sm",children:e.jsxs("div",{className:"d-flex align-items-start",children:[e.jsx("i",{className:"fas fa-exclamation-triangle fa-2x text-warning me-3"}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("h6",{className:"alert-heading mb-1",children:[e.jsx("i",{className:"fas fa-info-circle me-2"}),"Additional Items Selected"]}),e.jsxs("p",{className:"mb-1",children:[e.jsx("strong",{children:"Additional Charges:"})," ₱",ce.toLocaleString()]}),e.jsxs("p",{className:"mb-0 small",children:[e.jsx("i",{className:"fas fa-lightbulb me-1"}),e.jsx("strong",{children:"HMO/Maya payments only cover the service amount."}),` If the patient's HMO/Maya payment doesn't cover additional charges, select "Partially Paid" and enter the on-site payment amount for the additional items.`]})]})]})})}),e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-credit-card text-primary me-1"}),"Payment Status"]}),e.jsxs("select",{className:"form-select",value:Z,onChange:n=>_e(n.target.value),disabled:L,children:[e.jsx("option",{value:"paid",children:"Fully Paid"}),e.jsx("option",{value:"hmo_fully_covered",children:"HMO Fully Covered"}),e.jsx("option",{value:"partial",children:"Partially Paid (HMO didn't cover all)"}),e.jsx("option",{value:"unpaid",children:"Unpaid (Maya failed)"})]}),L&&e.jsxs("div",{className:"form-text text-muted",children:[e.jsx("i",{className:"fas fa-lock me-1"}),"Payment status cannot be changed as Maya payment is already completed."]})]}),Z==="partial"&&!L&&e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-money-bill text-primary me-1"}),"On-site Payment Amount (₱)"]}),e.jsxs("div",{className:"input-group",children:[e.jsx("span",{className:"input-group-text",children:"₱"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:W,className:"form-control",value:me,onChange:n=>he(n.target.value),placeholder:`Maximum: ${W.toLocaleString()}`})]}),e.jsxs("div",{className:"form-text",children:["Maximum amount: ₱",W.toLocaleString()]})]}),Z==="unpaid"&&!L&&e.jsxs("div",{className:"col-12",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"fas fa-exchange-alt text-primary me-1"}),"Payment Method Change"]}),e.jsxs("select",{className:"form-select",value:se,onChange:n=>ie(n.target.value),children:[e.jsx("option",{value:"",children:"Select change"}),e.jsx("option",{value:"maya_to_cash",children:"Change Maya to Cash Payment"})]})]})]})})]})]}),e.jsx("div",{className:"modal-footer bg-light border-top flex-shrink-0 py-3",style:{position:"sticky",bottom:0,zIndex:1,backgroundColor:"#f8f9fa"},children:e.jsxs("div",{className:"d-flex justify-content-between w-100 align-items-center",children:[e.jsx("div",{children:c>1&&e.jsxs("button",{type:"button",onClick:()=>P(c-1),className:"btn btn-outline-secondary",style:{minWidth:"100px"},children:[e.jsx("i",{className:"fas fa-arrow-left me-2"}),"Previous"]})}),e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs("small",{className:"text-muted me-3",children:["Step ",c," of 3"]}),c<3?e.jsxs("button",{type:"button",onClick:()=>P(c+1),className:"btn btn-primary",style:{minWidth:"100px"},children:["Next",e.jsx("i",{className:"fas fa-arrow-right ms-2"})]}):e.jsx("button",{type:"button",onClick:O,disabled:B,className:"btn btn-success",style:{minWidth:"140px"},children:B?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Completing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-check me-2"}),"Complete Visit"]})})]})]})})]})})}),U&&e.jsx("div",{className:"modal fade show d-block",style:{backgroundColor:"rgba(0,0,0,0.65)",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1060,display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem"},tabIndex:"-1",role:"dialog",children:e.jsx("div",{className:"modal-dialog",role:"document",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header bg-warning text-dark",children:[e.jsxs("h5",{className:"modal-title fw-bold",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"No Consumables Recorded"]}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>{k(!1),ee(null)},"aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("p",{children:"You are about to complete this visit without logging any inventory items. This will finalize the visit without reducing stock levels."}),e.jsx("p",{className:"mb-0 fw-semibold",children:"If items were used, please record them before continuing. Do you still want to complete the visit?"})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary",onClick:()=>{k(!1),ee(null)},children:"Cancel"}),e.jsx("button",{type:"button",className:"btn btn-warning",onClick:async()=>{k(!1),ye(!0),le&&await G(le)},disabled:B,children:"Complete Without Items"})]})]})})})]})}function xs({visit:r,onClose:C}){var z,E;const[D,c]=i.useState(""),[P,q]=i.useState(!1),[H,m]=i.useState(""),[F,Q]=i.useState(null),T=async I=>{var X,j;I.preventDefault(),q(!0),m("");try{const b=await S.post(`/api/visits/${r.id}/view-notes`,{password:D});Q(b.data.notes)}catch(b){m(((j=(X=b==null?void 0:b.response)==null?void 0:X.data)==null?void 0:j.message)||"Invalid password or failed to decrypt notes")}finally{q(!1)}},B=I=>I?e.jsxs("div",{className:"space-y-4",children:[I.dentist_notes&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Dentist Notes:"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded border",children:e.jsx("p",{className:"whitespace-pre-wrap",children:I.dentist_notes})})]}),I.findings&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Findings:"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded border",children:e.jsx("p",{className:"whitespace-pre-wrap",children:I.findings})})]}),I.treatment_plan&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"Treatment Plan:"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded border",children:e.jsx("p",{className:"whitespace-pre-wrap",children:I.treatment_plan})})]}),e.jsxs("div",{className:"text-sm text-gray-600 border-t pt-3",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Completed by:"})," Staff ID #",I.completed_by]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Completed at:"})," ",new Date(I.completed_at).toLocaleString()]})]})]}):null;return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",style:{padding:"1rem"},children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[calc(100vh-2rem)] flex flex-col overflow-hidden",children:[e.jsx("div",{className:"p-6 flex-shrink-0 sticky top-0 bg-white border-b z-10",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h2",{className:"text-xl font-bold",children:["Visit Notes - ",(z=r.patient)==null?void 0:z.first_name," ",(E=r.patient)==null?void 0:E.last_name]}),e.jsx("button",{onClick:C,className:"text-gray-500 hover:text-gray-700",children:"✕"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto overflow-x-hidden p-6",style:{minHeight:0},children:F?e.jsx("div",{children:B(F)}):e.jsxs("form",{onSubmit:T,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Enter your password to view encrypted notes:"}),e.jsx("input",{type:"password",className:"w-full border rounded px-3 py-2",value:D,onChange:I=>c(I.target.value),placeholder:"Enter your account password",required:!0}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"This action will be logged for security purposes."})]}),H&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded",children:H}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:C,className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:P||!D.trim(),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50",children:P?"Verifying...":"View Notes"})]})]})}),F&&e.jsx("div",{className:"p-6 flex-shrink-0 sticky bottom-0 bg-white border-t z-10",children:e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:C,className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:"Close"})})})]})})}function us({visit:r,onClose:C,onSuccess:D}){var se,ie,ne;const[c,P]=i.useState([]),[q,H]=i.useState(!0),[m,F]=i.useState(null),[Q,T]=i.useState(!1),[B,z]=i.useState(""),[E,I]=i.useState(null),[X,j]=i.useState(!1),[b,J]=i.useState(null),[l,N]=i.useState(!1),[A,V]=i.useState(""),[$,w]=i.useState(null),[U,k]=i.useState(null),[le,ee]=i.useState(!1);i.useEffect(()=>{ye()},[]);const de=d=>{if(!d)return null;if(typeof d.visit_date=="string"&&d.visit_date.length>=10)return d.visit_date.slice(0,10);if(typeof d.start_time=="string"&&d.start_time.length>=10){const g=d.start_time.includes(" ")?d.start_time.replace(" ","T"):d.start_time,v=new Date(g);if(!Number.isNaN(v.getTime()))try{return v.toISOString().slice(0,10)}catch{}const p=d.start_time.split(" ")[0];if(/^\d{4}-\d{2}-\d{2}$/.test(p))return p}return null};i.useEffect(()=>{var re;const d=r!=null&&r.assigned_dentist?{id:r.assigned_dentist.id??null,name:r.assigned_dentist.dentist_name||r.assigned_dentist.dentist_code||null,code:r.assigned_dentist.dentist_code??null}:null,g=de(r),v=g?(()=>{const te=new Date(g);if(!Number.isNaN(te.getTime()))try{return te.toISOString().slice(0,10)}catch{}return g})():null,p=new Date,y=new Date(p.getTime()-p.getTimezoneOffset()*6e4).toISOString().slice(0,10),R=v||y;if(!!!((re=r==null?void 0:r.patient)!=null&&re.id)){J(d),V(d?"":"Recent dentist: —");return}(async()=>{var te,ue,ce;N(!0),V("");try{let K=null;try{K=((te=(await S.get(`/api/patients/${r.patient.id}/preferred-dentist`,R?{params:{reference_date:R}}:void 0)).data)==null?void 0:te.preferred_dentist)??null}catch(W){console.error("Preferred dentist endpoint failed:",W)}if(!K&&R)try{const W=new URLSearchParams({date:R,with_meta:"1",patient_id:String(r.patient.id)}),L=((ce=(ue=(await S.get(`/api/appointment/available-services?${W.toString()}`)).data)==null?void 0:ue.metadata)==null?void 0:ce.preferred_dentist)??null;L&&(K={id:L.id??null,name:L.name||L.dentist_name||L.code||L.dentist_code||null,code:L.code||L.dentist_code||null})}catch(W){console.error("Available services metadata lookup failed:",W)}!K&&d&&(K=d),J(K),K||V("Recent dentist: —")}catch(K){console.error("Failed to resolve preferred dentist:",K),d?(J(d),V("")):(J(null),V("Recent dentist: —"))}finally{N(!1)}})()},[r]),i.useEffect(()=>{let d=!1;return(async()=>{if(!(r!=null&&r.appointment_id)){w(null),k(null);return}ee(!0);try{const v=await Z();if(d)return;const p=v==null?void 0:v.find(G=>G.id===r.appointment_id);if(!p){w(null),k(null);return}const y=!!p.honor_preferred_dentist;if(w(y),!y){k(null);return}const R=p.dentist_schedule_id;let O=(b==null?void 0:b.name)||(b==null?void 0:b.code)||null;if(!O&&R){const G=c.find(re=>re.id===R);G&&(O=G.dentist_name||G.dentist_code||null)}!O&&(r!=null&&r.assigned_dentist)&&R&&r.assigned_dentist.id===R&&(O=r.assigned_dentist.dentist_name||r.assigned_dentist.dentist_code||null),k(O)}catch(v){console.error("Failed to determine appointment preference:",v),d||(w(null),k(null))}finally{d||ee(!1)}})(),()=>{d=!0}},[r==null?void 0:r.appointment_id,c,b]);const ye=async()=>{H(!0),z("");try{const d=new Date,g=d.getDay(),p=["sun","mon","tue","wed","thu","fri","sat"][g],R=(await S.get("/api/dentists",{params:{status:"active"}})).data.filter(O=>O[p]===!0&&O.status==="active"&&(!O.contract_end_date||new Date(O.contract_end_date)>=d));console.log("Available dentists:",R),P(R)}catch(d){console.error("Failed to fetch dentists:",d),z("Failed to load available dentists. Please try again.")}finally{H(!1)}},Z=async()=>{var d;if(E)return E;j(!0);try{const g=await S.get("/api/appointments"),v=Array.isArray(g.data)?g.data:((d=g.data)==null?void 0:d.data)||[];return I(v),v}catch(g){return console.error("Failed to load appointments:",g),[]}finally{j(!1)}},_e=d=>{if(!(d!=null&&d.date)||!(d!=null&&d.time_slot))return null;const[g]=d.time_slot.split("-");if(!g)return null;const v=g.length===5?`${g}:00`:g,p=`${d.date}T${v}`,y=new Date(p);return isNaN(y.getTime())?null:y},me=async()=>{try{const d=await Z();if(!m)return!0;const g=new Date,v=d.filter(p=>p&&p.dentist_schedule_id===m.id&&["pending","approved"].includes(p.status)).map(p=>({appt:p,start:_e(p)})).find(({start:p})=>{if(!p)return!1;const y=(p.getTime()-g.getTime())/6e4;return y>=0&&y<=60});if(v!=null&&v.start){const p=v.start.toLocaleString(void 0,{hour:"2-digit",minute:"2-digit"});if(!window.confirm(`Dr. ${m.dentist_name||m.dentist_code} already has a dentist-specific appointment at ${p}. Do you still want to send this visit code?`))return!1}if(r!=null&&r.appointment_id){const p=d.find(y=>y.id===r.appointment_id);if(p&&p.honor_preferred_dentist&&p.dentist_schedule_id&&p.dentist_schedule_id!==m.id){const y=c.find(O=>O.id===p.dentist_schedule_id);if(!window.confirm(`This appointment is set to prefer ${(y==null?void 0:y.dentist_name)||(y==null?void 0:y.dentist_code)||"another dentist"}. Send the visit code to Dr. ${m.dentist_name||m.dentist_code} anyway?`))return!1}}return!0}catch(d){return console.error("Warning checks failed:",d),!0}},he=async()=>{var g,v;if(!m){z("Please select a dentist to send the visit code to.");return}if(!m.email){z("Selected dentist does not have an email address configured.");return}if(await me()){T(!0),z("");try{console.log("Sending visit code to dentist:",m);const p=await S.post("/api/visits/send-visit-code",{visit_id:r.id,dentist_id:m.id,dentist_email:m.email});_.success(`Visit code sent successfully to Dr. ${m.dentist_name||m.dentist_code}!`),D&&D(p.data,m),C()}catch(p){console.error("Failed to send visit code:",p);let y="Failed to send visit code. Please try again.";(v=(g=p.response)==null?void 0:g.data)!=null&&v.message?y=p.response.data.message:p.message&&(y=p.message),z(y)}finally{T(!1)}}};return e.jsx("div",{className:"modal show d-block",tabIndex:"-1",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1050,overflowY:"auto",display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem"},children:e.jsx("div",{className:"modal-dialog modal-lg",style:{margin:"0 auto",maxHeight:"calc(100vh - 2rem)",width:"100%"},children:e.jsxs("div",{className:"modal-content",style:{display:"flex",flexDirection:"column",maxHeight:"calc(100vh - 2rem)",overflow:"hidden"},children:[e.jsxs("div",{className:"modal-header flex-shrink-0",style:{position:"sticky",top:0,zIndex:1,backgroundColor:"#fff",borderBottom:"1px solid #dee2e6"},children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-send me-2"}),"Send Visit Code to Dentist"]}),e.jsx("button",{className:"btn-close",onClick:C,disabled:Q})]}),e.jsxs("div",{className:"modal-body flex-grow-1",style:{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:0},children:[e.jsxs("div",{className:"alert alert-info mb-4",children:[e.jsxs("h6",{className:"alert-heading",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),"Visit Information"]}),e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("strong",{children:"Patient:"})," ",(se=r.patient)==null?void 0:se.first_name," ",(ie=r.patient)==null?void 0:ie.last_name]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("strong",{children:"Visit Code:"}),e.jsx("span",{className:"badge bg-primary ms-2 fs-6",children:r.visit_code})]}),e.jsxs("div",{className:"col-md-6 mt-2",children:[e.jsx("strong",{children:"Service:"})," ",((ne=r.service)==null?void 0:ne.name)||"Not specified"]}),e.jsxs("div",{className:"col-md-6 mt-2",children:[e.jsx("strong",{children:"Started:"})," ",new Date(r.start_time).toLocaleString()]}),l?e.jsx("div",{className:"col-12 mt-2",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-hourglass-split me-1"}),"Checking recent dentist…"]})}):b?e.jsxs("div",{className:"col-md-6 mt-2",children:[e.jsx("strong",{children:"Recent Dentist:"})," ",b.name||b.code]}):null,le?e.jsx("div",{className:"col-12 mt-2",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-hourglass me-1"}),"Checking appointment preference…"]})}):$!==null?e.jsxs("div",{className:"col-md-6 mt-2",children:[e.jsx("strong",{children:"Appointment preference:"})," ",$?"Honor recent dentist":"Any available dentist",$&&U&&e.jsxs("div",{className:"small text-muted",children:["Preferred: ",U]})]}):null]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"form-label fw-semibold",children:[e.jsx("i",{className:"bi bi-person-badge me-2"}),"Select Available Dentist Today"]}),q?e.jsxs("div",{className:"text-center py-4",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"mt-2 text-muted",children:"Loading available dentists..."})]}):B&&!c.length?e.jsxs("div",{className:"alert alert-danger",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),B]}):c.length===0?e.jsxs("div",{className:"alert alert-warning",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"No dentists are scheduled to work today. Please check the dentist schedule."]}):e.jsx("div",{className:"row",children:c.map(d=>e.jsx("div",{className:"col-md-6 mb-3",children:e.jsx("div",{className:`card h-100 cursor-pointer border-2 ${(m==null?void 0:m.id)===d.id?"border-primary bg-light":"border-light"}`,style:{cursor:"pointer",transition:"all 0.2s ease"},onClick:()=>F(d),onMouseEnter:g=>{(m==null?void 0:m.id)!==d.id&&(g.target.style.borderColor="#0d6efd",g.target.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)")},onMouseLeave:g=>{(m==null?void 0:m.id)!==d.id&&(g.target.style.borderColor="#e9ecef",g.target.style.boxShadow="none")},children:e.jsx("div",{className:"card-body p-3",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("div",{className:"me-3",children:e.jsx("div",{className:"bg-primary text-white rounded-circle d-flex align-items-center justify-content-center",style:{width:"40px",height:"40px"},children:e.jsx("i",{className:"bi bi-person-fill"})})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("h6",{className:"card-title mb-1",children:["Dr. ",d.dentist_name||d.dentist_code]}),e.jsxs("small",{className:"text-muted",children:[d.dentist_code&&e.jsx("span",{className:"badge bg-secondary me-2",children:d.dentist_code}),d.employment_type&&e.jsx("span",{className:"text-capitalize",children:d.employment_type.replace("_"," ")})]}),d.email&&e.jsx("div",{className:"mt-1",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-envelope me-1"}),d.email]})})]}),(m==null?void 0:m.id)===d.id&&e.jsx("div",{className:"text-primary",children:e.jsx("i",{className:"bi bi-check-circle-fill fs-5"})})]})})})},d.id))})]}),B&&e.jsxs("div",{className:"alert alert-danger",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),B]})]}),e.jsxs("div",{className:"modal-footer flex-shrink-0",style:{position:"sticky",bottom:0,zIndex:1,backgroundColor:"#fff",borderTop:"1px solid #dee2e6"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:C,disabled:Q,children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:he,disabled:Q||X||!m||c.length===0,children:Q?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-send me-2"}),"Send Visit Code"]})})]})]})})})}const Ye=r=>{if(!r)return"";const C=new Date(r);if(Number.isNaN(C.getTime()))return"";const D=new Date;let c=D.getFullYear()-C.getFullYear();const P=D.getMonth()-C.getMonth();return(P<0||P===0&&D.getDate()<C.getDate())&&(c-=1),c<0?0:c>150?150:c},Ue=r=>{if(r===""||r===null||r===void 0)return"";const C=Number(r);if(Number.isNaN(C))return"";const D=Math.round(C);return D<0?0:D>150?150:D};function ps({visit:r,onClose:C,onSuccess:D}){const[c,P]=i.useState({}),[q,H]=i.useState(!0),[m,F]=i.useState(!1),[Q,T]=i.useState(""),[B,z]=i.useState(!1),[E,I]=i.useState(null);i.useEffect(()=>{X()},[r]);const X=async()=>{var l,N;H(!0),T("");try{const A=await S.get(`/api/visits/${r.id}/medical-history-form`),V=A.data.form_data||{},$=Ye(V.date_of_birth),w=$!==""?$:Ue(V.age);P({...V,age:w}),z(A.data.previous_history_exists||!1),I(A.data.previous_history_date||null)}catch(A){console.error("Failed to load medical history form:",A),T(((N=(l=A.response)==null?void 0:l.data)==null?void 0:N.message)||"Failed to load form data. Please try again.")}finally{H(!1)}},j=(l,N)=>{if(l==="date_of_birth"){const A=Ye(N);P(V=>({...V,date_of_birth:N,age:N?A===""?"":A:""}));return}if(l==="age"){P(A=>({...A,age:Ue(N)}));return}P(A=>({...A,[l]:N}))},b=(l,N)=>{P(A=>({...A,[l]:N}))},J=async l=>{var N,A,V,$;l.preventDefault(),F(!0),T("");try{const w=await S.post(`/api/visits/${r.id}/medical-history`,c);_.success(`Medical history completed successfully!

Visit Code: ${w.data.visit.visit_code}

You can now send this code to the dentist.`),D&&D(w.data),C()}catch(w){if(console.error("Failed to submit medical history:",w),(A=(N=w.response)==null?void 0:N.data)!=null&&A.errors){const U=Object.values(w.response.data.errors).flat().join(`
`);T(U)}else T((($=(V=w.response)==null?void 0:V.data)==null?void 0:$.message)||"Failed to submit medical history. Please try again.")}finally{F(!1)}};return q?e.jsx("div",{className:"modal show d-block",tabIndex:"-1",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1050},children:e.jsx("div",{className:"modal-dialog modal-xl modal-dialog-scrollable",style:{margin:"1rem auto",maxHeight:"calc(100vh - 2rem)"},children:e.jsx("div",{className:"modal-content",children:e.jsxs("div",{className:"modal-body text-center py-5",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"mt-3",children:"Loading medical history form..."})]})})})}):e.jsx("div",{className:"modal show d-block",tabIndex:"-1",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1050,display:"flex",alignItems:"center",justifyContent:"center",padding:"1rem"},children:e.jsx("div",{className:"modal-dialog modal-xl modal-dialog-scrollable",style:{margin:"1rem auto",maxHeight:"calc(100vh - 2rem)"},children:e.jsxs("div",{className:"modal-content",style:{maxHeight:"calc(100vh - 2rem)",display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs("div",{className:"modal-header flex-shrink-0",style:{position:"sticky",top:0,zIndex:1,backgroundColor:"#fff"},children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-file-medical me-2"}),"Dental and Medical History Form"]}),e.jsx("button",{className:"btn-close",onClick:C,disabled:m})]}),e.jsxs("form",{onSubmit:J,style:{display:"flex",flexDirection:"column",flex:"1 1 auto",minHeight:0},children:[e.jsxs("div",{className:"modal-body",style:{overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",minHeight:0},children:[B&&e.jsxs("div",{className:"alert alert-info",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),e.jsx("strong",{children:"Previous medical history found."})," Please review and update all information if the patient has visited other clinics or if there have been any changes.",E&&e.jsx("div",{className:"mt-2",children:e.jsxs("small",{children:["Last completed: ",new Date(E).toLocaleDateString()]})})]}),Q&&e.jsxs("div",{className:"alert alert-danger",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),Q]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-primary text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-person me-2"}),"Patient Information"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Full Name *"}),e.jsx("input",{type:"text",className:"form-control",value:c.full_name||"",onChange:l=>j("full_name",l.target.value),required:!0})]}),e.jsxs("div",{className:"col-md-3 mb-3",children:[e.jsx("label",{className:"form-label",children:"Age"}),e.jsx("input",{type:"number",className:"form-control",value:c.age||"",onChange:l=>j("age",l.target.value),min:"0",max:"150"})]}),e.jsxs("div",{className:"col-md-3 mb-3",children:[e.jsx("label",{className:"form-label",children:"Sex"}),e.jsxs("select",{className:"form-select",value:c.sex||"",onChange:l=>j("sex",l.target.value),children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"male",children:"Male"}),e.jsx("option",{value:"female",children:"Female"})]})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Address"}),e.jsx("input",{type:"text",className:"form-control",value:c.address||"",onChange:l=>j("address",l.target.value)})]}),e.jsxs("div",{className:"col-md-3 mb-3",children:[e.jsx("label",{className:"form-label",children:"Contact Number"}),e.jsx("input",{type:"text",className:"form-control",value:c.contact_number||"",onChange:l=>j("contact_number",l.target.value)})]}),e.jsxs("div",{className:"col-md-3 mb-3",children:[e.jsx("label",{className:"form-label",children:"Date of Birth"}),e.jsx("input",{type:"date",className:"form-control",value:c.date_of_birth||"",onChange:l=>j("date_of_birth",l.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Occupation"}),e.jsx("input",{type:"text",className:"form-control",value:c.occupation||"",onChange:l=>j("occupation",l.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Email"}),e.jsx("input",{type:"email",className:"form-control",value:c.email||"",onChange:l=>j("email",l.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Previous Dentist"}),e.jsx("input",{type:"text",className:"form-control",value:c.previous_dentist||"",onChange:l=>j("previous_dentist",l.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Last Dental Visit"}),e.jsx("input",{type:"date",className:"form-control",value:c.last_dental_visit||"",onChange:l=>j("last_dental_visit",l.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Physician Name"}),e.jsx("input",{type:"text",className:"form-control",value:c.physician_name||"",onChange:l=>j("physician_name",l.target.value)})]}),e.jsxs("div",{className:"col-md-6 mb-3",children:[e.jsx("label",{className:"form-label",children:"Physician Address"}),e.jsx("input",{type:"text",className:"form-control",value:c.physician_address||"",onChange:l=>j("physician_address",l.target.value)})]})]})})]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-primary text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-heart-pulse me-2"}),"Health Questions"]})}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.in_good_health||!1,onChange:l=>b("in_good_health",l.target.checked)}),"Are you in good health?"]})}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.under_medical_treatment||!1,onChange:l=>b("under_medical_treatment",l.target.checked)}),"Are you under medical treatment now?"]}),c.under_medical_treatment&&e.jsx("textarea",{className:"form-control mt-2",rows:"2",placeholder:"Please provide details...",value:c.medical_treatment_details||"",onChange:l=>j("medical_treatment_details",l.target.value)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.serious_illness_surgery||!1,onChange:l=>b("serious_illness_surgery",l.target.checked)}),"Have you had any serious illness or operation?"]}),c.serious_illness_surgery&&e.jsx("textarea",{className:"form-control mt-2",rows:"2",placeholder:"Please provide details...",value:c.illness_surgery_details||"",onChange:l=>j("illness_surgery_details",l.target.value)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.hospitalized||!1,onChange:l=>b("hospitalized",l.target.checked)}),"Have you been hospitalized in the past 2 years?"]}),c.hospitalized&&e.jsx("textarea",{className:"form-control mt-2",rows:"2",placeholder:"Please provide details...",value:c.hospitalization_details||"",onChange:l=>j("hospitalization_details",l.target.value)})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.taking_medications||!1,onChange:l=>b("taking_medications",l.target.checked)}),"Are you taking any medications?"]}),c.taking_medications&&e.jsx("textarea",{className:"form-control mt-2",rows:"2",placeholder:"Please list all medications...",value:c.medications_list||"",onChange:l=>j("medications_list",l.target.value)})]}),e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.uses_tobacco||!1,onChange:l=>b("uses_tobacco",l.target.checked)}),"Do you use tobacco?"]})}),e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.uses_alcohol_drugs||!1,onChange:l=>b("uses_alcohol_drugs",l.target.checked)}),"Do you use alcohol or drugs?"]})})]})]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-danger text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"Allergies"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.allergic_local_anesthetic||!1,onChange:l=>b("allergic_local_anesthetic",l.target.checked)}),"Local Anesthetic"]})}),e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.allergic_penicillin||!1,onChange:l=>b("allergic_penicillin",l.target.checked)}),"Penicillin"]})}),e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.allergic_sulfa||!1,onChange:l=>b("allergic_sulfa",l.target.checked)}),"Sulfa Drugs"]})}),e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.allergic_aspirin||!1,onChange:l=>b("allergic_aspirin",l.target.checked)}),"Aspirin"]})}),e.jsx("div",{className:"col-md-6 mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.allergic_latex||!1,onChange:l=>b("allergic_latex",l.target.checked)}),"Latex"]})}),e.jsxs("div",{className:"col-md-12 mb-3",children:[e.jsx("label",{className:"form-label",children:"Other Allergies"}),e.jsx("textarea",{className:"form-control",rows:"2",placeholder:"Please specify...",value:c.allergic_others||"",onChange:l=>j("allergic_others",l.target.value)})]})]})})]}),c.sex==="female"&&e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-info text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-gender-female me-2"}),"For Women Only"]})}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.is_pregnant||!1,onChange:l=>b("is_pregnant",l.target.checked)}),"Are you pregnant?"]})}),e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.is_nursing||!1,onChange:l=>b("is_nursing",l.target.checked)}),"Are you nursing?"]})}),e.jsx("div",{className:"mb-3",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c.taking_birth_control||!1,onChange:l=>b("taking_birth_control",l.target.checked)}),"Are you taking birth control pills?"]})})]})]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-success text-white",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-clipboard-pulse me-2"}),"Vital Information"]})}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-4 mb-3",children:[e.jsx("label",{className:"form-label",children:"Blood Type"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"e.g., O+, A-, etc.",value:c.blood_type||"",onChange:l=>j("blood_type",l.target.value)})]}),e.jsxs("div",{className:"col-md-4 mb-3",children:[e.jsx("label",{className:"form-label",children:"Blood Pressure"}),e.jsx("input",{type:"text",className:"form-control",placeholder:"e.g., 120/80",value:c.blood_pressure||"",onChange:l=>j("blood_pressure",l.target.value)})]}),e.jsxs("div",{className:"col-md-4 mb-3",children:[e.jsx("label",{className:"form-label",children:"Bleeding Time"}),e.jsx("input",{type:"text",className:"form-control",value:c.bleeding_time||"",onChange:l=>j("bleeding_time",l.target.value)})]})]})})]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("div",{className:"card-header bg-warning text-dark",children:e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-clipboard2-pulse me-2"}),"Medical Conditions"]})}),e.jsxs("div",{className:"card-body",children:[e.jsx("div",{className:"row",children:["high_blood_pressure","low_blood_pressure","heart_disease","heart_murmur","chest_pain","stroke","diabetes","hepatitis","tuberculosis","kidney_disease","cancer","asthma","anemia","arthritis","epilepsy","aids_hiv","stomach_troubles","thyroid_problems","hay_fever","head_injuries","rapid_weight_loss","joint_replacement","radiation_therapy","swollen_ankles"].map(l=>e.jsx("div",{className:"col-md-6 mb-2",children:e.jsxs("label",{className:"form-check-label",children:[e.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:c[l]||!1,onChange:N=>b(l,N.target.checked)}),l.split("_").map(N=>N.charAt(0).toUpperCase()+N.slice(1)).join(" ")]})},l))}),e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"form-label",children:"Other Conditions"}),e.jsx("textarea",{className:"form-control",rows:"3",placeholder:"Please specify any other medical conditions...",value:c.other_conditions||"",onChange:l=>j("other_conditions",l.target.value)})]})]})]})]}),e.jsxs("div",{className:"modal-footer flex-shrink-0",style:{position:"sticky",bottom:0,backgroundColor:"#fff",borderTop:"1px solid #dee2e6"},children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:C,disabled:m,children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:m,children:m?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),"Submit Medical History"]})})]})]})]})})})}function bs({show:r,onClose:C}){const[D,c]=i.useState(!1),[P,q]=i.useState(null);i.useEffect(()=>{r&&H()},[r]);const H=async()=>{c(!0);try{const m=await S.get("/api/staff/today-time-blocks");q(m.data)}catch(m){console.error("Failed to fetch time blocks:",m),_.error("Failed to load time blocks")}finally{c(!1)}};return r?e.jsx("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)"},children:e.jsx("div",{className:"modal-dialog modal-xl modal-dialog-scrollable",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header bg-primary text-white",children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-calendar-check me-2"}),"Today's Appointment Schedule"]}),e.jsx("button",{type:"button",className:"btn-close btn-close-white",onClick:C})]}),e.jsx("div",{className:"modal-body",children:D?e.jsx("div",{className:"text-center py-5",children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}):P!=null&&P.is_open?e.jsxs("div",{children:[e.jsxs("div",{className:"alert alert-info mb-4",children:[e.jsx("strong",{children:"Clinic Hours:"})," ",P.open_time," - ",P.close_time," |",e.jsx("strong",{className:"ms-3",children:"Capacity:"})," ",P.capacity," per slot"]}),e.jsx("div",{className:"time-block-container",children:P.blocks.map(m=>e.jsxs("div",{className:`card mb-3 ${m.count>0?"border-primary":"border-secondary"}`,children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{className:"mb-0",children:[e.jsx("i",{className:"bi bi-clock me-2"}),m.time]}),e.jsxs("span",{className:`badge ${m.count>0?"bg-primary":"bg-secondary"}`,children:[m.count," appointment",m.count!==1?"s":""]})]}),m.count>0&&e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"list-group list-group-flush",children:m.appointments.map(F=>e.jsx("div",{className:"list-group-item",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsxs("div",{children:[e.jsx("h6",{className:"mb-1",children:F.patient_name}),e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-bandaid me-1"}),F.service_name]}),e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-tag me-1"}),"Ref: ",F.reference_code]})]}),e.jsx("span",{className:`badge ${F.status==="completed"?"bg-success":"bg-info"}`,children:F.status})]})},F.id))})})]},m.time))})]}):e.jsxs("div",{className:"alert alert-info",children:[e.jsx("i",{className:"bi bi-info-circle me-2"}),"Clinic is closed today"]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:C,children:"Close"}),e.jsxs("button",{type:"button",className:"btn btn-primary",onClick:H,disabled:D,children:[e.jsx("i",{className:"bi bi-arrow-clockwise me-2"}),"Refresh"]})]})]})})}):null}function ks(){const[r,C]=i.useState([]),[D,c]=i.useState(!1),[P,q]=i.useState(!1),[H,m]=i.useState("walkin"),[F,Q]=i.useState(""),[T,B]=i.useState(null),[z,E]=i.useState(!1),[I,X]=i.useState(""),[j,b]=i.useState(!1),[J,l]=i.useState(null),[N,A]=i.useState(""),[V,$]=i.useState(!1),[w,U]=i.useState(null),[k,le]=i.useState({first_name:"",last_name:"",contact:"",service_id:""}),[ee,de]=i.useState([]),[ye,Z]=i.useState(!1),[_e,me]=i.useState(""),[he,se]=i.useState([]),[ie,ne]=i.useState(null),[d,g]=i.useState(!1),[v,p]=i.useState(null),[y,R]=i.useState(null),[O,G]=i.useState(null),[re,te]=i.useState(null),[ue,ce]=i.useState([]),[K,W]=i.useState(!1),[we,L]=i.useState(!1),[Me,pe]=i.useState(!1),[Se,be]=i.useState(null),[De,n]=i.useState(!1),[t,o]=i.useState({patient_id:"",first_name:"",last_name:"",contact_number:"",email:"",birthdate:"",service_id:"",date:"",start_time:"",payment_method:"cash",patient_hmo_id:"",teeth_count:"",linkToExisting:!1,honor_preferred_dentist:!0}),[f,fe]=i.useState([]),[Qe,Ee]=i.useState(!1),[Ve,$e]=i.useState(!1),[Y,Te]=i.useState(null),He=s=>{if(!s||typeof s!="object")return s;const a=["per_teeth_service","per_tooth_service","requires_teeth_count"],h={...s};return a.forEach(x=>{x in h&&(h[x]=!!h[x])}),h},Xe=s=>Array.isArray(s)?s.map(a=>typeof a=="string"?a:a&&typeof a.date=="string"?Object.prototype.hasOwnProperty.call(a,"preferred_dentist_present")&&a.preferred_dentist_present===!1?null:a.date:null).filter(Boolean):[],Re=s=>Array.isArray(s)?s.map(He):[],[Ce,Fe]=i.useState([]),[Ke,Oe]=i.useState(!1),[ge,Pe]=i.useState(null),[ke,Ae]=i.useState({dates:[],present:!1}),[je,Ne]=i.useState(null),Ie=!!(t.date&&ge&&(Array.isArray(ke.dates)&&ke.dates.includes(t.date)||ke.present===!0));i.useEffect(()=>{oe()},[]),i.useEffect(()=>{console.log("🔄 Visits state updated:",r),console.log("📊 Visit counts:",{total:r.length,pending:r.filter(s=>s.status==="pending").length,completed:r.filter(s=>s.status==="completed").length,rejected:r.filter(s=>s.status==="rejected").length})},[r]);const oe=async()=>{c(!0);try{console.log("🌐 Fetching visits from API...");const s=await S.get("/api/visits");console.log("📥 API response received:",s.data),console.log("📈 Number of visits received:",s.data.length),console.log("⏳ Visits with pending status:",s.data.filter(a=>a.status==="pending")),console.log("🔍 Visit IDs:",s.data.map(a=>{var h,x;return{id:a.id,status:a.status,patient:((h=a.patient)==null?void 0:h.first_name)+" "+((x=a.patient)==null?void 0:x.last_name)}})),C(s.data)}catch(s){console.error("❌ Failed to load visits",s)}finally{c(!1)}},Ze=async()=>{var s,a;q(!0);try{let h;if(H==="walkin")h={visit_type:"walkin"};else if(H==="appointment"){if(!T){_.error("Search and select a valid appointment first."),q(!1);return}h={visit_type:"appointment",reference_code:(F||"").toUpperCase().replace(/[^A-Z0-9]/g,"")}}console.log("🚀 Creating visit with payload:",h);const x=await S.post("/api/visits",h),u=x.data.visit||x.data;console.log("✅ Visit created successfully:",u),console.log("📋 Visit details:",{id:u.id,status:u.status,visit_code:u.visit_code,patient_id:u.patient_id,patient_name:((s=u.patient)==null?void 0:s.first_name)+" "+((a=u.patient)==null?void 0:a.last_name),start_time:u.start_time}),x.data.requires_medical_history?_("Visit created. Please complete the medical history form before sending the visit code to the dentist.",{icon:"ℹ️"}):u.visit_code&&_.success(`Visit started successfully!

Visit Code: ${u.visit_code}

Share this code with the dentist to begin consultation.`),console.log("➕ Adding new visit to state:",u),C(M=>{const ae=[u,...M];return console.log("🔄 Updated visits state with new visit:",ae),console.log("🎯 New visit should now be visible in the list"),ae}),Q(""),B(null),console.log("🔄 Fetching visits after creation to ensure consistency..."),await new Promise(M=>setTimeout(M,200)),await oe(),console.log("✅ Visit creation process completed")}catch(h){console.error("Error creating visit:",h),_.error("Failed to start visit.")}finally{q(!1)}},Ge=async(s,a)=>{{const h=r.find(x=>x.id===s);if(!h.service_id){_.error("Please select a service for this patient before finishing the visit. Use the 'Edit' button to assign a service.");return}if(!h.visit_code_sent_at){_.error("Send the visit code to a dentist before completing the visit.");return}p(h);return}},Je=async()=>{await oe()},es=async s=>{var a,h;G(s);try{const x=await S.post(`/api/receipts/visit/${s}/email`,{},{skip401Handler:!0});x.data.note?_.success(`${x.data.message}

${x.data.note}`):_.success(`Receipt sent successfully to ${x.data.email}`)}catch(x){console.error("Failed to send receipt email",x);const u=((h=(a=x.response)==null?void 0:a.data)==null?void 0:h.message)||"Failed to send receipt email. Please try again.";_.error(u)}finally{G(null)}},ss=async()=>{E(!0),B(null),X("");try{const s=(F||"").toUpperCase().replace(/[^A-Z0-9]/g,"");if(s.length!==8){X("Enter the full 8-character code.");return}const a=await S.get(`/api/appointment/resolve/${s}`);B(a.data)}catch{X("Invalid or used reference code.")}finally{E(!1)}},ts=async s=>{var a,h,x;U(s),le({first_name:((a=s.patient)==null?void 0:a.first_name)||"",last_name:((h=s.patient)==null?void 0:h.last_name)||"",contact:((x=s.patient)==null?void 0:x.contact)||"",service_id:s.service_id||""});try{const u=new Date().toISOString().slice(0,10),M=await S.get(`/api/appointment/available-services?date=${u}`),ae=Array.isArray(M.data)?M.data:M.data.data||[];de(Re(ae))}catch{_.error("Failed to load services.")}},as=async()=>{var s;try{const a=await S.put(`/api/visits/${w.id}/update-patient`,{first_name:k.first_name,last_name:k.last_name,contact_number:k.contact.trim()!==""?k.contact.trim():(s=w.patient)==null?void 0:s.contact_number,service_id:k.service_id||null});if(a.data.potential_matches&&a.data.potential_matches.length>0)ce(a.data.potential_matches),W(!0);else{const h=w;if(U(null),await oe(),!h.appointment_id&&k.service_id)try{const x=await S.get(`/api/visits/${h.id}`);x.data.medical_history_status==="pending"&&(be(x.data),pe(!0))}catch(x){console.error("Failed to fetch updated visit for medical history:",x)}}}catch{_.error("Failed to update patient.")}},ls=s=>{be(s),pe(!0)},is=async s=>{await oe(),pe(!1),be(null)},ns=async()=>{o({patient_id:"",first_name:"",last_name:"",contact_number:"",email:"",birthdate:"",service_id:"",date:"",start_time:"",payment_method:"cash",patient_hmo_id:"",teeth_count:"",linkToExisting:!1,honor_preferred_dentist:!0}),Te(null),fe([]),Fe([]),Pe(null),Ae({dates:[],present:!1}),Ne(null),de([]),L(!0)},rs=async s=>{var a,h,x;if(o(u=>({...u,date:s,start_time:"",service_id:"",teeth_count:"",honor_preferred_dentist:!1})),fe([]),Te(null),Ne(null),s){Oe(!0);try{const u=await S.get(`/api/dentists/available-for-date?date=${s}`);Fe(u.data.dentists||[])}catch(u){console.error("Failed to load dentists for date:",u),Fe([])}finally{Oe(!1)}try{const u=new URLSearchParams({date:s,with_meta:"1"});t.linkToExisting&&t.patient_id&&u.set("patient_id",t.patient_id);const M=await S.get(`/api/appointment/available-services?${u.toString()}`),ae=Array.isArray((a=M.data)==null?void 0:a.services)?M.data.services:Array.isArray(M.data)?M.data:((h=M.data)==null?void 0:h.data)||[];de(Re(ae));const xe=((x=M.data)==null?void 0:x.metadata)??null;if(xe){const ve=Xe(xe.highlight_dates??[]),We=xe.preferred_dentist_present??ve.includes(s);Pe(xe.preferred_dentist??null),Ae({dates:ve,present:xe.preferred_dentist_present??We}),o(ms=>({...ms,honor_preferred_dentist:We}))}else Pe(null),Ae({dates:[],present:!1}),o(ve=>({...ve,honor_preferred_dentist:!1}))}catch(u){console.error("Failed to load services for new date:",u),de([]),Pe(null),Ae({dates:[],present:!1}),o(M=>({...M,honor_preferred_dentist:!1}))}}else Fe([]),de([]),Pe(null),Ae({dates:[],present:!1}),o(u=>({...u,honor_preferred_dentist:!1}))},cs=async s=>{const a=ee.find(h=>h.id==s);Te(a?He(a):null),o(h=>({...h,service_id:s,start_time:"",teeth_count:""})),fe([]),Ne(null),s&&t.date&&a&&!a.per_teeth_service&&await Le(t.date,s,t.teeth_count)},qe=async s=>{o(a=>({...a,teeth_count:s,start_time:""})),fe([]),Ne(null),t.date&&t.service_id&&s&&s>0&&await Le(t.date,t.service_id,s)},os=async s=>{o(a=>({...a,honor_preferred_dentist:s,start_time:""})),fe([]),Ne(null),t.date&&t.service_id&&await Le(t.date,t.service_id,t.teeth_count||null,s)},Le=async(s,a,h=null,x=t.honor_preferred_dentist)=>{Ee(!0);try{const u={date:s,service_id:a};h&&(u.teeth_count=h),u.honor_preferred_dentist=x?1:0,t.linkToExisting&&t.patient_id&&(u.patient_id=t.patient_id);const M=await S.get("/api/appointment/available-slots",{params:u});fe(M.data.slots||M.data),Ne(M.data.metadata??null)}catch(u){console.error("Failed to fetch available slots:",u),fe([]),Ne(null)}finally{Ee(!1)}},Be=s=>{if(!s)return null;const a=new Date(s),h=new Date,x=new Date;return x.setFullYear(h.getFullYear()-4),a>h?"Birthdate cannot be in the future.":a>x?"Patient must be at least 4 years old.":null},ze=()=>{const s=new Date;return s.setFullYear(s.getFullYear()-4),s.toISOString().split("T")[0]},ds=async()=>{var a,h;if(!t.service_id||!t.date||!t.start_time){_.error("Please select service, date, and time.");return}if(Y&&Y.per_teeth_service&&!t.teeth_count){_.error("Please enter the number of teeth for this per-teeth service.");return}const s=Be(t.birthdate);if(s){_.error(s);return}if(!t.linkToExisting&&(!t.first_name||!t.last_name||!t.contact_number)){_.error("Please fill in patient details including contact number (required for SMS reminders) or link to existing patient.");return}if(t.linkToExisting&&!t.patient_id){_.error("Please select an existing patient.");return}$e(!0);try{const x={service_id:t.service_id,date:t.date,start_time:t.start_time,payment_method:t.payment_method,honor_preferred_dentist:t.honor_preferred_dentist};t.linkToExisting?x.patient_id=t.patient_id:(x.first_name=t.first_name,x.last_name=t.last_name,x.contact_number=t.contact_number,t.email&&(x.email=t.email),t.birthdate&&(x.birthdate=t.birthdate)),t.payment_method==="hmo"&&t.patient_hmo_id&&(x.patient_hmo_id=t.patient_hmo_id),t.teeth_count&&(x.teeth_count=parseInt(t.teeth_count));const u=await S.post("/api/appointments/staff-create",x);_.success(`Appointment created successfully!
Reference Code: ${u.data.appointment.reference_code}`),L(!1)}catch(x){const u=((h=(a=x.response)==null?void 0:a.data)==null?void 0:h.message)||"Failed to create appointment.";_.error(u)}finally{$e(!1)}};return e.jsxs("div",{className:"h-100 d-flex flex-column",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("h3",{children:"📝 Patient Visit Tracker"}),e.jsxs("button",{className:"btn btn-outline-primary",onClick:()=>n(!0),children:[e.jsx("i",{className:"bi bi-calendar-check me-2"}),"View Today's Schedule"]})]}),e.jsxs("div",{className:"card p-3 mb-4",children:[e.jsx("label",{children:"Visit Type"}),e.jsxs("select",{className:"form-select mb-2",value:H,onChange:s=>{m(s.target.value),B(null),Q(""),X("")},children:[e.jsx("option",{value:"walkin",children:"Walk-in"}),e.jsx("option",{value:"appointment",children:"Appointment"})]}),H==="appointment"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"input-group mb-2",children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"Enter Appointment Reference Code",value:F,onChange:s=>Q(s.target.value.toUpperCase())}),e.jsx("button",{className:"btn btn-outline-primary",onClick:ss,disabled:z||!F,children:z?"Searching...":"Search"})]}),I&&e.jsx("div",{className:"text-danger",children:I}),T&&e.jsxs("div",{className:"alert alert-success",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{children:T.patient_name})," —"," ",T.service_name," @ ",T.date," /"," ",T.time_slot]}),T.last_visit&&e.jsxs("div",{className:"mt-2 p-2 bg-light rounded",children:[e.jsx("small",{className:"text-muted",children:"📋 Last Visit:"}),e.jsxs("div",{className:"small",children:[e.jsx("strong",{children:"Date:"})," ",new Date(T.last_visit.visit_date).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})," |"," ",e.jsx("strong",{children:"Service:"})," ",T.last_visit.service_name||"N/A",T.last_visit.teeth_treated&&e.jsxs(e.Fragment,{children:[" | ",e.jsx("strong",{children:"Teeth Treated:"})," ",T.last_visit.teeth_treated]})]})]}),!T.last_visit&&e.jsx("div",{className:"mt-2 p-2 bg-light rounded",children:e.jsx("small",{className:"text-muted",children:"📋 No previous visits found"})})]})]}),e.jsxs("div",{className:"d-flex gap-2 mt-2",children:[e.jsx("button",{className:"btn btn-primary",onClick:Ze,disabled:P,children:P?"Saving...":"Start Visit"}),e.jsx("button",{className:"btn btn-success",onClick:ns,children:"📅 Make Appointment"})]})]}),e.jsxs("div",{className:"flex-grow-1 d-flex flex-column",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs("h5",{className:"mb-0",children:["Ongoing Visits (",r.length," total, ",r.filter(s=>s.status==="pending").length," pending)"]}),D&&e.jsxs("div",{className:"d-flex align-items-center text-muted ms-3",children:[e.jsx("div",{className:"spinner-border spinner-border-sm me-2",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("small",{children:"Loading visits..."})]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:oe,children:"🔄 Refresh"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>g(s=>!s),children:d?"🔽 Hide Completed/Rejected":"🔼 Show All Today's Visits"})]})]}),e.jsx("div",{className:"table-responsive flex-grow-1",children:e.jsxs("table",{className:"table table-bordered table-hover mb-0",children:[e.jsx("thead",{className:"table-light sticky-top",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Contact"}),e.jsx("th",{children:"Visit Code"}),e.jsx("th",{children:"Service"}),e.jsx("th",{children:"Note"}),e.jsx("th",{children:"Started At"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Medical History"}),e.jsx("th",{style:{minWidth:"200px"},children:"Actions"})]})}),e.jsx("tbody",{children:(()=>{const s=r.filter(a=>d||a.status==="pending");return console.log("All visits:",r),console.log("Show all visits:",d),console.log("Filtered visits:",s),s})().map(s=>{var u,M,ae,xe,ve;const a=!!s.service_id&&!!s.visit_code_sent_at,h=((u=s.assigned_dentist)==null?void 0:u.dentist_name)||((M=s.assigned_dentist)==null?void 0:M.dentist_code)||null,x=s.visit_code_sent_at?new Date(s.visit_code_sent_at).toLocaleString("en-PH",{dateStyle:"medium",timeStyle:"short"}):null;return console.log("Rendering visit:",s.id,"Patient:",s.patient),e.jsxs("tr",{children:[e.jsxs("td",{children:[(ae=s.patient)==null?void 0:ae.first_name," ",(xe=s.patient)==null?void 0:xe.last_name]}),e.jsx("td",{children:((ve=s.patient)==null?void 0:ve.contact_number)||"—"}),e.jsx("td",{children:s.visit_code?e.jsx("span",{className:"badge bg-primary",children:s.visit_code}):"—"}),e.jsx("td",{children:s.service?e.jsx("span",{className:"badge bg-info",children:s.service.name}):e.jsxs("span",{className:"badge bg-warning",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-1"}),"No Service"]})}),e.jsx("td",{children:s.status==="completed"&&s.visit_notes?e.jsx("button",{className:"btn btn-sm btn-outline-info",onClick:()=>R(s),children:"🔒 View Notes"}):"—"}),e.jsx("td",{children:s.start_time?new Date(s.start_time).toLocaleString("en-PH",{dateStyle:"medium",timeStyle:"short"}):"—"}),e.jsx("td",{children:s.status}),e.jsx("td",{children:s.medical_history_status==="completed"?e.jsxs("span",{className:"badge bg-success",children:[e.jsx("i",{className:"bi bi-check-circle me-1"}),"Completed"]}):e.jsxs("span",{className:"badge bg-warning text-dark",children:[e.jsx("i",{className:"bi bi-clock me-1"}),"Pending"]})}),e.jsxs("td",{children:[s.status==="pending"&&e.jsxs("div",{className:"d-flex gap-1 flex-wrap",children:[e.jsx("button",{className:"btn btn-warning btn-sm",onClick:()=>ts(s),children:"Edit"}),e.jsxs("button",{className:`btn btn-sm ${s.medical_history_status==="completed"?"btn-success":"btn-info"}`,onClick:()=>ls(s),title:s.medical_history_status==="completed"?"View/Edit Medical History":"Complete Medical History",children:[e.jsx("i",{className:`bi ${s.medical_history_status==="completed"?"bi-check-circle":"bi-file-medical"} me-1`}),"Medical History"]}),s.visit_code?e.jsxs("button",{className:"btn btn-primary btn-sm",onClick:()=>te(s),disabled:s.medical_history_status==="pending",title:s.medical_history_status==="pending"?"Complete medical history first":"Send visit code to dentist",children:[e.jsx("i",{className:"bi bi-send me-1"}),"Send Visit Code to Dentist"]}):e.jsxs("span",{className:"badge bg-warning text-dark",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-1"}),"Medical History Required"]}),e.jsx("div",{className:"small text-muted w-100",children:h?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-person-badge me-1"}),"Assigned dentist: ",h,x&&e.jsxs("div",{children:[e.jsx("i",{className:"bi bi-clock-history me-1"}),"Sent: ",x]})]}):e.jsxs("span",{children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Visit code not yet sent"]})}),e.jsx("button",{className:`btn btn-sm ${a?"btn-success":"btn-outline-secondary"}`,onClick:()=>Ge(s.id),disabled:!a,title:s.service_id?s.visit_code_sent_at?"Complete this visit":"Send the visit code before completing this visit":"Please select a service first",children:s.service_id?"Finish":e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-1"}),"Finish"]})}),e.jsx("button",{className:"btn btn-danger btn-sm",onClick:()=>{l(s.id),A(""),$(!1),b(!0)},children:"Reject"})]}),s.status==="completed"&&e.jsx("div",{className:"d-flex gap-1 flex-wrap",children:e.jsx("button",{className:"btn btn-success btn-sm",onClick:()=>es(s.id),disabled:O===s.id,title:"Send Receipt Email",children:O===s.id?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-envelope me-1"}),"Send Receipt"]})})})]})]},s.id)})})]})})]}),j&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:N==="inquiry_only"?"Mark as Inquiry":"Reject Visit"}),e.jsx("button",{className:"btn-close",onClick:()=>b(!1)})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("label",{className:"form-label",children:N==="inquiry_only"?"Reason for inquiry:":"Reason for rejection:"}),e.jsxs("select",{className:"form-select",value:N,onChange:s=>A(s.target.value),children:[e.jsx("option",{value:"",children:"Select reason"}),e.jsx("option",{value:"human_error",children:"Human Error"}),e.jsx("option",{value:"left",children:"Patient Left"}),e.jsx("option",{value:"line_too_long",children:"Line Too Long"}),e.jsx("option",{value:"inquiry_only",children:"Inquiry Only"})]}),N==="line_too_long"&&e.jsxs("div",{className:"form-check mt-2",children:[e.jsx("input",{type:"checkbox",className:"form-check-input",checked:V,onChange:s=>$(s.target.checked),id:"offerAppt"}),e.jsx("label",{htmlFor:"offerAppt",className:"form-check-label",children:"Patient was offered an appointment"})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>b(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-danger",disabled:!N,onClick:async()=>{await S.post(`/api/visits/${J}/reject`,{reason:N,offered_appointment:V}),b(!1),l(null),await oe()},children:N==="inquiry_only"?"Mark as Inquiry":"Confirm Reject"})]})]})})}),w&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Edit Patient Info"}),e.jsx("button",{className:"btn-close",onClick:()=>U(null)})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("label",{className:"form-label",children:"First Name"}),e.jsx("input",{className:"form-control mb-2",value:k.first_name,onChange:s=>le({...k,first_name:s.target.value})}),e.jsx("label",{className:"form-label",children:"Last Name"}),e.jsx("input",{className:"form-control mb-2",value:k.last_name,onChange:s=>le({...k,last_name:s.target.value})}),e.jsx("label",{className:"form-label",children:"Contact"}),e.jsx("input",{className:"form-control mb-2",value:k.contact,onChange:s=>le({...k,contact:s.target.value})}),e.jsx("label",{className:"form-label",children:"Service"}),e.jsxs("select",{className:"form-select",value:k.service_id,onChange:s=>le({...k,service_id:s.target.value}),children:[e.jsx("option",{value:"",children:"— Select —"}),ee.map(s=>e.jsxs("option",{value:s.id,children:[s.name," –"," ",s.type==="promo"?`₱${Number(s.promo_price).toLocaleString()} (${s.discount_percent}% off)`:s.type==="special"?`₱${Number(s.price).toLocaleString()} Special Service`:`₱${Number(s.price).toLocaleString()}`]},s.id))]}),e.jsx("hr",{}),e.jsx("button",{className:"btn btn-outline-secondary",onClick:()=>{Z(!0),me(""),se([]),ne(null)},children:"🔗 Link to Existing Patient"})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>U(null),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:as,children:"Save"})]})]})})}),ye&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"Link to Existing Patient"}),e.jsx("button",{className:"btn-close",onClick:()=>Z(!1)})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("input",{className:"form-control mb-2",placeholder:"Search by name or contact (min 2 characters)",value:_e,onChange:async s=>{const a=s.target.value;if(me(a),se([]),ne(null),a.length>=2)try{const h=await S.get("/api/patients/search",{params:{q:a.trim()}});se(h.data)}catch{_.error("Search failed.")}}}),he.filter(s=>{var a;return s.id!==((a=w==null?void 0:w.patient)==null?void 0:a.id)}).length>0?e.jsxs("table",{className:"table table-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Contact"}),e.jsx("th",{children:"Birthdate"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:he.filter(s=>{var a;return s.id!==((a=w==null?void 0:w.patient)==null?void 0:a.id)}).map(s=>e.jsxs("tr",{children:[e.jsxs("td",{children:[s.first_name," ",s.last_name]}),e.jsx("td",{children:s.contact_number||"—"}),e.jsx("td",{children:s.birthdate?new Date(s.birthdate).toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"}):"—"}),e.jsx("td",{children:e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>ne(s),children:"Select"})})]},s.id))})]}):e.jsxs("table",{className:"table table-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Contact"}),e.jsx("th",{children:"Birthdate"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"text-muted text-center",children:"No matching patients found."})})})]}),ie&&e.jsxs("div",{className:"alert alert-info mt-3",children:["Link current visit to"," ",e.jsxs("strong",{children:[ie.first_name," ",ie.last_name]}),"?"]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>Z(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",disabled:!ie,onClick:async()=>{try{const s={target_patient_id:ie.id};k.service_id&&(s.service_id=k.service_id),await S.post(`/api/visits/${w.id}/link-existing`,s),Z(!1),U(null),await oe()}catch{_.error("Failed to link to patient.")}},children:"Confirm Link"})]})]})})}),K&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header bg-warning",children:[e.jsx("h5",{className:"modal-title",children:"⚠️ Potential Duplicate Patient Found"}),e.jsx("button",{className:"btn-close",onClick:()=>{W(!1),U(null)}})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"alert alert-warning",children:[e.jsx("strong",{children:"Warning:"})," We found existing patient(s) with the same name. This might be a duplicate entry. Please review and link if this is the same patient."]}),e.jsx("h6",{children:"Matching Patients:"}),ue.map(s=>e.jsx("div",{className:"card mb-2 p-3",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsxs("strong",{children:[s.first_name," ",s.last_name]}),e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["Contact: ",s.contact_number||"N/A",e.jsx("br",{}),"Birthdate: ",s.birthdate?new Date(s.birthdate).toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"}):"N/A",e.jsx("br",{}),s.has_user_account&&e.jsxs("span",{className:"badge bg-success",children:["Has Online Account (",s.user_email,")"]})]})]}),e.jsx("button",{className:"btn btn-primary",onClick:async()=>{if(window.confirm(`Link this visit to ${s.first_name} ${s.last_name}?`))try{const a={target_patient_id:s.id};k.service_id&&(a.service_id=k.service_id),await S.post(`/api/visits/${w.id}/link-existing`,a),W(!1),U(null),await oe(),_.success("Visit successfully linked to existing patient!")}catch{_.error("Failed to link visit to patient.")}},children:"Link to This Patient"})]})},s.id)),e.jsx("hr",{}),e.jsx("p",{className:"text-muted",children:e.jsx("small",{children:"If none of these patients match, you can close this dialog and the walk-in patient record will remain separate."})})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-secondary",onClick:()=>{W(!1),U(null)},children:"Keep as Separate Patient"})})]})})}),v&&e.jsx(hs,{visit:v,onClose:()=>p(null),onComplete:Je}),y&&e.jsx(xs,{visit:y,onClose:()=>R(null)}),re&&e.jsx(us,{visit:re,onClose:()=>te(null),onSuccess:async()=>{await oe()}}),Me&&Se&&e.jsx(ps,{visit:Se,onClose:()=>{pe(!1),be(null)},onSuccess:is}),we&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"📅 Create Appointment for Walk-in Patient"}),e.jsx("button",{className:"btn-close",onClick:()=>L(!1)})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("h6",{children:"Patient Information"}),e.jsxs("div",{className:"form-check mb-3",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"linkToExisting",checked:t.linkToExisting,onChange:s=>o(a=>({...a,linkToExisting:s.target.checked,patient_id:s.target.checked?a.patient_id:"",first_name:s.target.checked?"":a.first_name,last_name:s.target.checked?"":a.last_name,contact_number:s.target.checked?"":a.contact_number,email:s.target.checked?"":a.email,birthdate:s.target.checked?"":a.birthdate}))}),e.jsx("label",{className:"form-check-label",htmlFor:"linkToExisting",children:"Link to existing patient"})]}),t.linkToExisting?e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Search Existing Patient"}),e.jsx("input",{className:"form-control",placeholder:"Search by name or contact (min 2 characters)",value:_e,onChange:async s=>{const a=s.target.value;if(me(a),se([]),ne(null),a.length>=2)try{const h=await S.get("/api/patients/search",{params:{q:a.trim()}});se(h.data)}catch{_.error("Search failed.")}}}),he.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("small",{className:"text-muted",children:"Select a patient:"}),he.map(s=>e.jsx("div",{className:"card p-2 mb-1 cursor-pointer",onClick:()=>{o(a=>({...a,patient_id:s.id})),ne(s)},style:{cursor:"pointer",backgroundColor:t.patient_id===s.id?"#e3f2fd":"white"},children:e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsxs("div",{children:[e.jsxs("strong",{children:[s.first_name," ",s.last_name]}),e.jsx("br",{}),e.jsxs("small",{className:"text-muted",children:["Contact: ",s.contact_number||"N/A"," | Birthdate: ",s.birthdate?new Date(s.birthdate).toLocaleDateString():"N/A"]})]}),t.patient_id===s.id&&e.jsx("span",{className:"badge bg-primary",children:"Selected"})]})},s.id))]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentFirstName",children:"First Name *"}),e.jsx("input",{className:"form-control",value:t.first_name,onChange:s=>o(a=>({...a,first_name:s.target.value})),id:"staffAppointmentFirstName"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentLastName",children:"Last Name *"}),e.jsx("input",{className:"form-control",value:t.last_name,onChange:s=>o(a=>({...a,last_name:s.target.value})),id:"staffAppointmentLastName"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentContact",children:"Contact Number *"}),e.jsx("input",{className:"form-control",value:t.contact_number,onChange:s=>o(a=>({...a,contact_number:s.target.value})),placeholder:"Required for SMS reminders",id:"staffAppointmentContact"}),e.jsxs("div",{className:"form-text",children:[e.jsx("i",{className:"bi bi-phone me-1"}),"Required for SMS appointment reminders"]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Email (Optional)"}),e.jsx("input",{type:"email",className:"form-control",value:t.email,onChange:s=>o(a=>({...a,email:s.target.value}))})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Birthdate (Optional)"}),e.jsx("input",{type:"date",className:"form-control",value:t.birthdate,onChange:s=>{const a=s.target.value;o(x=>({...x,birthdate:a}));const h=Be(a);h&&_.error(h)},max:ze()}),e.jsxs("div",{className:"form-text",children:["Must be at least 4 years old (dates after ",ze()," are not selectable)."]})]})]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsx("h6",{children:"Appointment Details"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentDate",children:"Date *"}),e.jsx("input",{type:"date",className:"form-control",value:t.date,onChange:s=>rs(s.target.value),min:new Date().toISOString().slice(0,10),max:new Date(Date.now()+7*24*60*60*1e3).toISOString().slice(0,10),placeholder:"Select a date",id:"staffAppointmentDate"}),e.jsxs("div",{className:"form-text",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),t.date?"You can only select dates up to 7 days from today":"Please select a date first to see available dentists and services"]}),ge&&e.jsxs("div",{className:"alert alert-info border-0 shadow-sm mt-3",children:[e.jsx("strong",{children:"Recent dentist:"})," ",ge.name||ge.code,e.jsx("div",{className:"small mt-2",children:Array.isArray(ke.dates)&&ke.dates.length>0?e.jsxs(e.Fragment,{children:["Available on:"," ",e.jsx("span",{className:"fw-semibold",children:ke.dates.join(", ")})]}):"No upcoming availability recorded."}),t.date&&!Ie&&e.jsx("div",{className:"small text-muted mt-2",children:"Your dentist is not scheduled on this selected date."})]})]}),e.jsxs("div",{className:"form-check form-switch mb-3",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"staffHonorPreferredDentistSwitch",checked:t.honor_preferred_dentist,onChange:s=>os(s.target.checked),disabled:!ge||!Ie}),e.jsx("label",{className:"form-check-label",htmlFor:"staffHonorPreferredDentistSwitch",children:"Prefer assigning to recent dentist"}),!ge&&e.jsx("div",{className:"form-text",children:"No recent dentist found for this patient yet; any dentist can be assigned."}),ge&&t.date&&!Ie&&e.jsx("div",{className:"form-text text-muted",children:"Dentist not available on this date."})]}),t.date&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Available Dentists"}),Ke?e.jsxs("div",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-hourglass-split me-1"}),"Loading available dentists..."]}):Ce.length>0?e.jsxs("div",{className:"alert alert-info border-0 shadow-sm",children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("div",{children:[e.jsx("i",{className:"bi bi-person-check me-2"}),e.jsxs("strong",{children:[Ce.length," dentist",Ce.length!==1?"s":""," available"]})]}),e.jsx("span",{className:"badge bg-primary",children:Ce.length})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("small",{className:"text-muted",children:"Available dentists:"}),e.jsx("div",{className:"mt-1",children:Ce.map((s,a)=>e.jsxs("span",{className:"badge bg-light text-dark me-1 mb-1",children:[s.dentist_name," (",s.dentist_code,")"]},a))})]})]}):e.jsxs("div",{className:"alert alert-warning border-0 shadow-sm",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"No dentists available on this date"]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentService",children:"Service *"}),e.jsxs("select",{className:"form-select",value:t.service_id,onChange:s=>cs(s.target.value),disabled:!t.date,id:"staffAppointmentService",children:[e.jsx("option",{value:"",children:t.date?"Select a service":"Please select a date first"}),ee.map(s=>e.jsxs("option",{value:s.id,children:[s.name," –"," ",s.type==="promo"?`₱${Number(s.promo_price).toLocaleString()} (${s.discount_percent}% off)`:s.type==="special"?`₱${Number(s.price).toLocaleString()} Special Service`:`₱${Number(s.price).toLocaleString()}`,s.per_teeth_service?" per tooth":""]},s.id))]}),!t.date&&e.jsxs("div",{className:"form-text text-muted",children:[e.jsx("i",{className:"bi bi-lock me-1"}),"Please select a date first to enable service selection"]})]}),Y&&e.jsx("div",{className:"alert alert-info border-0 shadow-sm mb-4",role:"alert",children:e.jsx("div",{className:"d-flex align-items-center justify-content-between flex-wrap",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx("i",{className:"bi bi-check-circle me-3 fs-4"}),e.jsxs("div",{children:[e.jsx("strong",{children:"Service Selected:"}),e.jsx("br",{}),e.jsx("span",{className:"fs-5",children:Y.name}),e.jsx("br",{}),e.jsxs("span",{className:"text-info fw-semibold",children:["₱",Number(Y.price||Y.promo_price).toLocaleString(),Y.per_teeth_service?" per tooth":""]}),Y.per_teeth_service&&e.jsx("div",{className:"mt-2",children:e.jsxs("small",{className:"text-info",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Total cost depends on number of teeth treated"]})})]})]})})}),Y&&Y.per_teeth_service&&e.jsx("div",{className:"alert alert-warning border-0 shadow-sm mb-4",role:"alert",children:e.jsxs("div",{className:"d-flex align-items-start",children:[e.jsx("i",{className:"bi bi-lightbulb me-3 fs-4 text-warning"}),e.jsxs("div",{children:[e.jsxs("h6",{className:"alert-heading text-warning mb-2",children:[e.jsx("i",{className:"bi bi-tooth me-2"}),"Per-Teeth Service Information"]}),e.jsx("p",{className:"mb-2",children:"For per-teeth services, please enter the number of teeth that need treatment. This will determine:"}),e.jsxs("ul",{className:"mb-2 ps-3",children:[e.jsx("li",{children:"Appointment duration"}),e.jsx("li",{children:"Available time slots"}),e.jsx("li",{children:"Accurate cost calculation"})]})]})]})}),Y&&Y.per_teeth_service&&e.jsxs("div",{className:"mb-3",children:[e.jsxs("label",{className:"form-label",children:["Number of Teeth to be Treated *",e.jsx("span",{className:"text-muted ms-1",children:"(Required for per-teeth services)"})]}),e.jsxs("div",{className:"position-relative",children:[e.jsx("input",{type:"number",min:"1",max:"32",className:"form-control",value:t.teeth_count,onChange:s=>{const a=s.target.value;(a===""||parseInt(a)>=1&&parseInt(a)<=32)&&qe(a)},placeholder:"Select or enter number of teeth",style:{paddingRight:"60px"}}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2",onClick:()=>{const s=document.getElementById("teethCountModal");s&&(new bootstrap.Modal(s).show(),setTimeout(()=>{const h=s.querySelector(".teeth-roulette"),x=s.querySelector(`[data-teeth="${t.teeth_count}"]`);if(h&&x&&t.teeth_count){const u=x.offsetTop,M=h.clientHeight,ae=x.clientHeight;h.scrollTop=u-M/2+ae/2}},300))},style:{height:"32px",width:"40px",padding:"0"},children:e.jsx("i",{className:"bi bi-chevron-down"})})]}),e.jsx("div",{className:"modal fade",id:"teethCountModal",tabIndex:"-1","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-dialog-centered",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h5",{className:"modal-title",children:[e.jsx("i",{className:"bi bi-tooth me-2"}),"Select Number of Teeth"]}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body p-0",children:e.jsx("div",{className:"teeth-roulette",style:{height:"200px",overflowY:"auto",padding:"10px",scrollBehavior:"smooth",touchAction:"pan-y",WebkitOverflowScrolling:"touch"},onScroll:s=>{s.target.scrollTop=Math.round(s.target.scrollTop/50)*50},onTouchStart:s=>{s.target.style.backgroundColor="#f8f9fa"},onTouchEnd:s=>{setTimeout(()=>{s.target.style.backgroundColor="transparent"},150)},children:Array.from({length:32},(s,a)=>a+1).map(s=>e.jsx("div",{"data-teeth":s,className:`teeth-option d-flex align-items-center justify-content-center p-3 border-bottom cursor-pointer ${t.teeth_count==s?"bg-primary text-white":"bg-light"}`,onClick:()=>{qe(s.toString());const a=document.getElementById("teethCountModal");a&&bootstrap.Modal.getInstance(a).hide()},style:{minHeight:"50px",cursor:"pointer",transition:"all 0.2s ease",userSelect:"none"},onMouseEnter:a=>{t.teeth_count!=s&&(a.target.style.backgroundColor="#e9ecef")},onMouseLeave:a=>{t.teeth_count!=s&&(a.target.style.backgroundColor="#f8f9fa")},children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"fs-4 fw-bold",children:s}),e.jsx("div",{className:"small",children:s===1?"tooth":"teeth"}),t.teeth_count==s&&e.jsx("div",{className:"small",children:e.jsx("i",{className:"bi bi-check-circle-fill"})})]})},s))})}),e.jsx("div",{className:"modal-footer",children:e.jsx("div",{className:"w-100 text-center",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Swipe to scroll • Tap to select • Max 32 teeth"]})})})]})})}),e.jsxs("div",{className:"form-text",children:[e.jsx("i",{className:"bi bi-info-circle me-1"}),"Enter the number of teeth that need treatment. Time slots will be calculated based on this.",t.teeth_count&&e.jsxs("div",{className:"mt-1",children:[e.jsx("strong",{children:"Estimated cost:"})," ₱",Number(Y.price||Y.promo_price)*parseInt(t.teeth_count||0).toLocaleString()]})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",htmlFor:"staffAppointmentTimeSlot",children:"Time Slot *"}),Qe?e.jsx("div",{className:"text-muted",children:"Loading available slots..."}):f.length>0?e.jsxs(e.Fragment,{children:[(je==null?void 0:je.preferred_dentist)&&e.jsxs("div",{className:"alert alert-info border-0 shadow-sm mb-2",children:[e.jsx("i",{className:"bi bi-person-badge me-2"}),t.honor_preferred_dentist?"Scheduling with:":"Suggested dentist:"," ",je.preferred_dentist.name||je.preferred_dentist.code]}),je&&je.effective_honor_preferred_dentist===!1&&t.honor_preferred_dentist&&e.jsxs("div",{className:"alert alert-warning border-0 shadow-sm mb-2",children:[e.jsx("i",{className:"bi bi-exclamation-triangle me-2"}),"Preferred dentist is unavailable for the selected slot. Another dentist will be assigned."]}),e.jsxs("select",{className:"form-select",value:t.start_time,onChange:s=>o(a=>({...a,start_time:s.target.value})),id:"staffAppointmentTimeSlot",children:[e.jsx("option",{value:"",children:"Select time slot"}),f.map(s=>e.jsx("option",{value:s,children:s},s))]})]}):t.service_id&&t.date?e.jsx("div",{className:"text-muted",children:Y&&Y.per_teeth_service&&!t.teeth_count?"Please enter number of teeth first to see available time slots.":"No available slots for this service on this date."}):e.jsx("div",{className:"text-muted",children:t.date?t.service_id?"Please select service and date first.":"Please select a service first.":"Please select a date first."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Payment Method *"}),e.jsxs("select",{className:"form-select",value:t.payment_method,onChange:s=>o(a=>({...a,payment_method:s.target.value})),disabled:!t.date||!t.service_id,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"maya",children:"Maya Payment"}),e.jsx("option",{value:"hmo",children:"HMO"})]}),(!t.date||!t.service_id)&&e.jsxs("div",{className:"form-text text-muted",children:[e.jsx("i",{className:"bi bi-lock me-1"}),"Please select date and service first to enable payment method selection"]})]}),t.payment_method==="hmo"&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"HMO (Optional)"}),e.jsx("select",{className:"form-select",value:t.patient_hmo_id,onChange:s=>o(a=>({...a,patient_hmo_id:s.target.value})),children:e.jsx("option",{value:"",children:"No HMO selected"})})]})]})]})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>L(!1),children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:ds,disabled:Ve,children:Ve?"Creating...":"Create Appointment"})]})]})})}),e.jsx(bs,{show:De,onClose:()=>n(!1)})]})}export{ks as default};
